<!DOCTYPE html>
<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë           BARTLETT'S ORDER MANAGEMENT SYSTEM                     ‚ïë
  ‚ïë                                                                  ‚ïë
  ‚ïë  ¬© 2025 Oscar Rivas. All rights reserved.                        ‚ïë
  ‚ïë  Bartlett's Restaurant ‚Äî Austin, TX                              ‚ïë
  ‚ïë                                                                  ‚ïë
  ‚ïë  This software is the proprietary property of Oscar Rivas.       ‚ïë
  ‚ïë  Unauthorized copying, distribution, modification, or use        ‚ïë
  ‚ïë  of this application, in whole or in part, without the           ‚ïë
  ‚ïë  express written permission of Oscar Rivas is strictly           ‚ïë
  ‚ïë  prohibited.                                                      ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  CURRENT VERSION: v1.5                                           ‚îÇ
  ‚îÇ  FILE: index.html                                                ‚îÇ
  ‚îÇ  LAST UPDATED: 2026-02-26                                        ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  CHANGELOG
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  v1.5 ‚Äî 2026-02-26
  ¬∑ Full Trimark step-by-step guide added to Must Know tab (6 steps with emojis)
  ¬∑ ‚ùì HOW TO button added to inventory mode header ‚Äî slides up quick reference sheet
  ¬∑ Inline smart hints appear at top of inventory view based on current state:
    - Missing BEGIN numbers warning with instructions
    - Uncounted items reminder with count remaining
    - Suspicious zero alert for high-par items showing 0
    - Green all-clear banner when all items are counted
  ¬∑ Help sheet closes on tap outside or GOT IT button

  v1.4 ‚Äî 2026-02-26
  ¬∑ Trimark order triggers üìß Email James prompt after saving
  ¬∑ Opens mail app pre-filled to James.Hawley@trimarkusa.com
  ¬∑ Subject: "Bartlett's Trimark Order ‚Äî [date]"
  ¬∑ Body: itemized list with -x{qty} {name} format, signed Oscar Rivas
  ¬∑ If both ABCO and Trimark ordered, prompts appear sequentially (0.8s apart)

  v1.3 ‚Äî 2026-02-26
  ¬∑ Delivery date selector added to save modal
  ¬∑ Quick chips: Tomorrow (default), In 2 days, In 3 days, Pick date‚Ä¶
  ¬∑ Selected date shows as "üìÖ Wednesday, February 27" preview before saving
  ¬∑ Delivery date stored in order snapshot
  ¬∑ Print report shows üöö EXPECTED DELIVERY banner prominently in header

  v1.2 ‚Äî 2026-02-26
  ¬∑ ABCO SMS reformatted ‚Äî items grouped in rows of 3
  ¬∑ Each item prefixed with dash e.g. "-x3 Bio Pak #3   -x2 Foil 18"   -x1 Trash Liners"
  ¬∑ Cleaner, easier to read at a glance for Hal

  v1.1 ‚Äî 2026-02-26
  ¬∑ Monthly report redesigned with larger fonts for readability
  ¬∑ Item rows: 17px name, 22px bold qty, 15px pack size
  ¬∑ Header: 32px title, 28px month name, 32px summary tile numbers
  ¬∑ Table headers: 13px, rows padded 14px vertical for clear separation
  ¬∑ Print button enlarged (17px), summary tiles thicker borders
  ¬∑ Responsive viewport meta added for mobile report viewing

  v1.0 ‚Äî 2026-02-26
  ¬∑ Trimark tally modal upgraded to multi-entry per location
  ¬∑ Each location (Dock, Closet, Restaurant) accepts space-separated numbers
  ¬∑ e.g. "8  2  3  2" sums to 15 ‚Äî live subtotal shown per location
  ¬∑ Raw entries saved and restored when reopening modal for same item
  ¬∑ Grand total still auto-fills COUNT field and triggers row recalculation

  v0.9 ‚Äî 2026-02-26
  ¬∑ Added version numbers, auto index.html naming, changelog comments
  ¬∑ Added PIN lock screen (default PIN: 2408) with lockout after 5 attempts
  ¬∑ Generated PDF quick-start guide with QR code for staff onboarding
  ¬∑ Fixed Firebase "reference error: firebase undefined" on load
  ¬∑ Added 500ms delay + retry logic for Firebase SDK initialization

  v0.8 ‚Äî 2026-02-26
  ¬∑ Firebase real-time sync across all devices (bartletts-rest-op project)
  ¬∑ History tab grouped by month with sticky month headers
  ¬∑ Added üìä REPORT button per month ‚Äî opens full printable monthly report
  ¬∑ Monthly report shows total qty ordered, order count, alerts per item

  v0.7 ‚Äî 2026-02-26
  ¬∑ Copyright signature embedded: ¬© 2025 Oscar Rivas
  ¬∑ Copyright in top bar, footer, print view, and HTML source comment
  ¬∑ BARTLETT'S brand name changed to red (#ef4444)
  ¬∑ BEK supplier tab changed to navy blue (#0f172a / #60a5fa)

  v0.6 ‚Äî 2026-02-26
  ¬∑ Trimark expanded to all 41 items matching December 2025 spreadsheet
  ¬∑ Added: Espresso/Cappuccino/Latte Saucers, Gravy Boats, Spin bowl,
    Key Lime pie plate, S&P mills, Pate Knives ‚Äî with correct par + costs
  ¬∑ December 2025 ending counts pre-loaded as January BEGIN values
  ¬∑ Unit costs corrected across all Trimark items from spreadsheet data

  v0.5 ‚Äî 2026-02-25
  ¬∑ Location tally modal for Trimark COUNT field
  ¬∑ Tap COUNT ‚Üí modal with Dock / Closet / Restaurant inputs
  ¬∑ Total auto-calculates live; breakdown shown under count (e.g. 12¬∑0¬∑24)
  ¬∑ Tally data persists to localStorage and clears on monthly save/reset

  v0.4 ‚Äî 2026-02-25
  ¬∑ ABCO save triggers SMS prompt to text Hal (512-801-5422)
  ¬∑ Pre-fills message with all ordered items + quantities
  ¬∑ Prompt auto-dismisses after 12 seconds if not used

  v0.3 ‚Äî 2026-02-25
  ¬∑ Full Trimark monthly inventory cycle (replaces simple breakage log)
  ¬∑ BEGIN / COUNT / USED / ORDER columns with live auto-calculation
  ¬∑ Breakage cost display (usage √ó unit cost per item)
  ¬∑ Location tally foundation; summary bar with total loss $
  ¬∑ Monthly save carries ending counts ‚Üí next month's beginning
  ¬∑ History detail and print view updated with Trimark inventory columns

  v0.2 ‚Äî 2026-02-25
  ¬∑ Multi-supplier support: ABCO, BEK, TRIMARK, AMAZON
  ¬∑ Supplier tab bar with color-coded active states
  ¬∑ Order history with detail view and print view
  ¬∑ Must Know tab with operational notes
  ¬∑ Edit mode for item catalog (name, pack, par)
  ¬∑ PWA support ‚Äî installable on iOS and Android

  v0.1 ‚Äî 2026-02-25
  ¬∑ Initial build ‚Äî Bartlett's Order Management PWA
  ¬∑ Basic order entry with on-hand counts and order quantities
  ¬∑ Local storage persistence
  ¬∑ Save & reset workflow

  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

  <!-- PWA / iOS home screen meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bartlett's">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <meta name="application-name" content="Bartlett's Orders">
  <meta name="description" content="Bartlett's Restaurant Order Management">

  <!-- Icons (embedded as base64 ‚Äî no server needed) -->
  <link rel="apple-touch-icon" href="data:image/png;base64,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">
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,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">
  <link rel="icon" type="image/png" sizes="512x512" href="data:image/png;base64,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">

  <!-- Inline PWA manifest as data URI (works without a server) -->
  <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Bartlett's%20Order%20Management%22%2C%22short_name%22%3A%22Bartlett's%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23000000%22%2C%22theme_color%22%3A%22%23000000%22%2C%22orientation%22%3A%22portrait-primary%22%7D">

  <title>Bartlett's ¬∑ Order Management</title>

  <style>
    /* System fonts ‚Äî no internet needed, native on every Apple device */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; height: 100%; }
    body {
      background: #000;
      overflow: hidden;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
      color: #f2f2f7;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: auto;
    }
    ::-webkit-scrollbar { display: none; }
    input, textarea, button, select {
      -webkit-appearance: none; appearance: none; outline: none;
      font-family: inherit;
    }
    input[type=number] { -moz-appearance: textfield; }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    button { cursor: pointer; }

    /* Install banner */
    #install-banner {
      position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
      background: #14532d;
      padding: 12px 16px;
      padding-top: calc(12px + env(safe-area-inset-top, 0px));
      display: flex; align-items: center; gap: 12px;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      transform: translateY(-100%);
      transition: transform 0.35s ease;
    }
    #install-banner.show { transform: translateY(0); }
    #install-banner .ib-icon {
      width: 44px; height: 44px; border-radius: 10px; flex-shrink: 0;
      background: #0a0a0a; display: flex; align-items: center; justify-content: center;
      font-size: 24px;
    }
    #install-banner .ib-text { flex: 1; }
    #install-banner .ib-title { color: #4ade80; font-size: 12px; font-weight: 700; letter-spacing: 0.5px; }
    #install-banner .ib-sub { color: rgba(255,255,255,0.55); font-size: 10px; margin-top: 2px; line-height: 1.4; }
    #install-banner .ib-close {
      width: 32px; height: 32px; border-radius: 16px; border: none;
      background: rgba(0,0,0,0.3); color: #4ade80; font-size: 18px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }

    #app {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      background: #000;
      overflow: hidden;
      padding-top: env(safe-area-inset-top, 0px);
    }

    /* Top bar */
    #topbar {
      background: #111; border-bottom: 1px solid #1c1c1e;
      padding: 0 16px; height: 52px;
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .brand-name { font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-weight: 700; font-size: 14px; color: #ef4444; letter-spacing: 1px; }
    .brand-sub  { font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 9px; color: #2c2c2e; letter-spacing: 2px; }
    .topbar-right { display: flex; align-items: center; gap: 8px; }
    .date-chip { color: #3a3a3c; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 10px; }

    .btn-edit {
      height: 40px; padding: 0 14px; border-radius: 20px;
      border: 2px solid #2c2c2e; background: transparent; color: #636366;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 11px; font-weight: 700;
      display: flex; align-items: center; gap: 5px; transition: all 0.15s;
    }
    .btn-edit.active { border-color: #fbbf24; background: rgba(251,191,36,0.12); color: #fbbf24; }

    .btn-save {
      height: 40px; padding: 0 16px; border-radius: 20px; border: none;
      background: #4ade80; color: #000;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 12px; font-weight: 800;
      display: flex; align-items: center; gap: 5px;
    }
    .btn-save:active { transform: scale(0.97); }

    /* Content area */
    #content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

    /* Supplier tab bar */
    .sup-tabs {
      display: flex; overflow-x: auto; gap: 8px; padding: 10px 16px;
      background: #000; -webkit-overflow-scrolling: touch;
      scrollbar-width: none; flex-shrink: 0;
    }
    .sup-tab {
      flex-shrink: 0; height: 44px; padding: 0 18px; border-radius: 22px;
      border: 2px solid #2c2c2e; background: #1c1c1e; color: #636366;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 11px; font-weight: 700;
      letter-spacing: 0.5px; white-space: nowrap;
      display: flex; align-items: center; gap: 7px; transition: all 0.15s;
    }
    .sup-tab.active { color: #fff; }
    .sup-tab-badge {
      border-radius: 99px; min-width: 18px; height: 18px; padding: 0 4px;
      font-size: 10px; font-weight: 800;
      display: flex; align-items: center; justify-content: center;
    }

    /* Supplier info strip */
    .sup-info { padding: 8px 16px; flex-shrink: 0; }
    .sup-info-sched { color: #fff; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 11px; }
    .sup-info-contact { color: rgba(255,255,255,0.5); font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 10px; margin-top: 1px; }
    .sup-info-alerts { margin-top: 4px; display: flex; gap: 12px; }

    /* Edit mode banner */
    .edit-banner {
      background: #1a1a00; border-bottom: 2px solid #fbbf24;
      padding: 10px 16px; display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .edit-banner-title { color: #fbbf24; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 12px; font-weight: 700; }
    .edit-banner-sub { color: #78716c; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 10px; margin-top: 1px; }
    .btn-done-edit {
      height: 36px; padding: 0 14px; border-radius: 18px;
      border: 2px solid #fbbf24; background: transparent; color: #fbbf24;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 11px; font-weight: 700;
    }

    /* Item list */
    #item-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    .item-row {
      border-bottom: 1px solid #1c1c1e;
      display: flex; flex-direction: column;
      overflow: hidden; position: relative;
    }
    .item-row-inner {
      display: flex; align-items: center; gap: 10px;
      padding: 11px 16px; min-height: 64px;
      transition: transform 0.2s ease; position: relative; z-index: 1;
      background: inherit;
    }
    .swipe-clear-btn {
      position: absolute; right: 0; top: 0; bottom: 0;
      width: 80px; background: #dc2626;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 2px; z-index: 0;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace;
      font-size: 9px; font-weight: 700; color: #fff; letter-spacing: 0.5px;
      cursor: pointer;
    }
    .item-name { color: #f2f2f7; font-size: 15px; font-weight: 500; line-height: 1.3; }
    .item-meta { color: #48484a; font-size: 12px; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; margin-top: 2px; display: flex; gap: 8px; }
    .item-par-edit { color: #fbbf24; }

    .inp-col { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .inp-label { color: #48484a; font-size: 9px; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; letter-spacing: 0.8px; }
    .inp-field {
      width: 58px; height: 44px; background: #1c1c1e;
      border: 2px solid #2c2c2e; border-radius: 12px;
      color: #fff; text-align: center;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 17px;
    }
    .inp-field:focus { outline: none; }

    .note-btn {
      width: 34px; height: 34px; border-radius: 10px; border: none;
      background: #2c2c2e; color: #555; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
    }
    .note-btn.has-note { background: rgba(251,191,36,0.18); color: #fbbf24; }

    .edit-item-btn {
      width: 36px; height: 36px; border-radius: 10px;
      border: 2px solid #4ade80; background: rgba(74,222,128,0.1);
      color: #4ade80; font-size: 15px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
    }

    .note-drawer { padding: 0 16px 12px; }
    .note-textarea {
      width: 100%; background: #1c1c1e; border: 1.5px solid #3a3a3c;
      border-radius: 12px; color: #f2f2f7; padding: 10px 12px;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif; font-size: 15px;
      resize: none; box-sizing: border-box;
    }

    /* Global notes area */
    .global-notes-area { padding: 20px 16px 8px; }
    .section-label {
      color: #636366; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace;
      font-size: 11px; letter-spacing: 1px; margin-bottom: 8px;
      display: flex; align-items: center; gap: 6px;
    }
    .global-textarea {
      width: 100%; background: #1c1c1e; border: 2px solid #2c2c2e;
      border-radius: 14px; color: #f2f2f7;
      padding: 14px; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif; font-size: 16px;
      resize: none; box-sizing: border-box; line-height: 1.5;
    }
    .global-textarea.has-content { border-color: #fbbf24; }

    /* Bottom tab bar */
    #tabbar {
      background: #111; border-top: 1px solid #1c1c1e;
      display: flex; flex-shrink: 0;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    .tab-btn {
      flex: 1; height: 56px; border: none; background: transparent;
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; gap: 2px; color: #636366; position: relative;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace;
    }
    .tab-btn.active { color: #4ade80; }
    .tab-btn .tab-emoji { font-size: 22px; line-height: 1; }
    .tab-btn .tab-label { font-size: 10px; font-weight: 700; letter-spacing: 0.5px; }
    .tab-indicator {
      position: absolute; top: 0; left: 50%; transform: translateX(-50%);
      width: 32px; height: 2px; background: #4ade80; border-radius: 1px;
    }

    /* History */
    .filter-chips {
      display: flex; overflow-x: auto; gap: 8px; padding: 10px 16px;
      background: #000; -webkit-overflow-scrolling: touch;
      scrollbar-width: none; flex-shrink: 0;
    }
    .chip {
      flex-shrink: 0; height: 36px; padding: 0 14px; border-radius: 18px;
      border: 2px solid #2c2c2e; background: #1c1c1e; color: #636366;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 11px; font-weight: 700; white-space: nowrap;
    }
    .chip.active { border-color: #4ade80; background: #14532d; color: #4ade80; }

    #history-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    .hist-row {
      border-bottom: 1px solid #1c1c1e; display: flex; align-items: center;
    }
    .hist-row-btn {
      flex: 1; text-align: left; background: transparent; border: none;
      padding: 14px 16px; display: flex; align-items: center; gap: 14px; min-height: 72px;
    }
    .hist-date-tile {
      width: 50px; height: 56px; background: #1c1c1e; border-radius: 14px;
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; flex-shrink: 0;
    }
    .hist-print-btn {
      width: 50px; height: 72px; border: none; border-left: 1px solid #1c1c1e;
      background: transparent; color: #4ade80; font-size: 20px;
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; gap: 3px; flex-shrink: 0;
    }
    .hist-print-label { font-size: 8px; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; color: #3a3a3c; }

    /* History detail */
    #hist-detail { flex: 1; display: flex; flex-direction: column; overflow: hidden; display: none; }
    #hist-detail.show { display: flex; }
    .detail-header {
      background: #111; padding: 12px 16px; flex-shrink: 0;
      display: flex; align-items: center; gap: 12px;
      border-bottom: 1px solid #1c1c1e;
    }
    .btn-back {
      width: 44px; height: 44px; border-radius: 22px; border: none;
      background: #2c2c2e; color: #4ade80; font-size: 22px;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-print-detail {
      height: 40px; padding: 0 14px; border-radius: 20px;
      border: 1.5px solid #4ade80; background: transparent; color: #4ade80;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 11px; font-weight: 700;
      display: flex; align-items: center; gap: 6px;
    }
    #detail-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    /* Modals / sheets */
    .sheet-overlay {
      position: fixed; inset: 0; z-index: 100;
      background: rgba(0,0,0,0.72);
      display: flex; align-items: flex-end;
      -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
    }
    .sheet {
      width: 100%; background: #1c1c1e;
      border-radius: 20px 20px 0 0;
      padding: 8px 20px 0;
      padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
    }
    .sheet-handle {
      width: 36px; height: 4px; background: #3a3a3c; border-radius: 2px;
      margin: 0 auto 20px;
    }
    .sheet-title { color: #f2f2f7; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 17px; font-weight: 800; margin-bottom: 8px; }
    .sheet-sub { color: #8e8e93; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif; font-size: 15px; line-height: 1.55; margin-bottom: 24px; }
    .btn-confirm {
      width: 100%; height: 56px; border-radius: 16px; border: none;
      background: #4ade80; color: #000;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 16px; font-weight: 800; letter-spacing: 0.8px;
    }
    .btn-confirm:active { transform: scale(0.98); }
    .btn-cancel {
      width: 100%; height: 50px; border-radius: 16px; border: none;
      background: transparent; color: #8e8e93;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 15px; font-weight: 600;
      margin-top: 6px;
    }

    /* Edit item sheet specific */
    .edit-field-label { color: #636366; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 10px; letter-spacing: 1px; margin-bottom: 6px; }
    .edit-field-wrap { margin-bottom: 14px; }
    .edit-input {
      width: 100%; background: #2c2c2e; border: 2px solid #4ade80;
      border-radius: 12px; color: #f2f2f7; padding: 12px 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; box-sizing: border-box;
    }
    .edit-input[type=number] { font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; }

    /* Toast */
    #toast {
      position: fixed;
      bottom: calc(72px + env(safe-area-inset-bottom, 0px) + 12px);
      left: 50%; transform: translateX(-50%) translateY(12px);
      border-radius: 30px; padding: 12px 24px;
      font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 13px; font-weight: 700;
      z-index: 500; white-space: nowrap; pointer-events: none;
      box-shadow: 0 8px 40px rgba(0,0,0,0.7);
      opacity: 0; transition: opacity 0.2s, transform 0.2s;
      background: #14532d; color: #fff;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.warn { background: #78350f; }
    #toast.error { background: #7f1d1d; }

    /* Empty state */
    .empty-state { padding: 48px; text-align: center; }
    .empty-icon { font-size: 40px; margin-bottom: 12px; }
    .empty-text { color: #3a3a3c; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 13px; }

    /* Safe area spacer */
    .safe-bottom { height: env(safe-area-inset-bottom, 16px); min-height: 16px; }

    /* Detail supplier block */
    .detail-sup-header {
      padding: 9px 16px; display: flex; justify-content: space-between; align-items: center;
    }
    .detail-item {
      padding: 11px 16px; border-bottom: 1px solid #1c1c1e;
    }
    .detail-item.critical { background: rgba(248,113,113,0.08); }
    .detail-item.low { background: rgba(251,191,36,0.06); }
    .detail-item.alt { background: #111; }
    .detail-values { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .detail-val-col { text-align: center; }
    .detail-val-label { color: #48484a; font-size: 9px; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; }
    .detail-val { color: #aeaeb2; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-size: 15px; font-weight: 600; }
    .detail-val.ordered { color: #f97316; font-weight: 700; }
    .detail-val.empty { color: #3a3a3c; }
    .item-note-box {
      margin-top: 8px; background: rgba(251,191,36,0.09);
      border-radius: 8px; padding: 7px 10px;
      color: #d4a000; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif; font-size: 13px; font-style: italic;
    }

    /* Supplier badge */
    .sup-badge {
      border-radius: 6px; padding: 2px 7px;
      font-size: 10px; font-family: ui-monospace, 'SF Mono', 'Courier New', monospace; font-weight: 700; color: #fff;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js" crossorigin="anonymous"></script>
</head>
<body>

<!-- PIN Lock Screen -->
<div id="pin-screen" style="
  position:fixed;inset:0;background:#000;z-index:99999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-family:ui-monospace,'SF Mono','Courier New',monospace;
  padding:env(safe-area-inset-top,0) env(safe-area-inset-right,0) env(safe-area-inset-bottom,0) env(safe-area-inset-left,0);
">
  <div style="color:#ef4444;font-size:22px;font-weight:800;letter-spacing:2px;margin-bottom:4px;">BARTLETT'S</div>
  <div style="color:#3a3a3c;font-size:10px;letter-spacing:2px;margin-bottom:40px;">ORDER MANAGEMENT</div>

  <div style="color:#636366;font-size:12px;letter-spacing:1px;margin-bottom:20px;">ENTER PIN</div>

  <!-- Dots -->
  <div id="pin-dots" style="display:flex;gap:16px;margin-bottom:36px;">
    <div class="pin-dot"></div>
    <div class="pin-dot"></div>
    <div class="pin-dot"></div>
    <div class="pin-dot"></div>
  </div>

  <!-- Error msg -->
  <div id="pin-error" style="color:#f87171;font-size:11px;letter-spacing:1px;height:16px;margin-bottom:16px;"></div>

  <!-- Keypad -->
  <div style="display:grid;grid-template-columns:repeat(3,72px);grid-template-rows:repeat(4,64px);gap:12px;">
    <button class="pin-key" onclick="pinPress('1')">1</button>
    <button class="pin-key" onclick="pinPress('2')">2</button>
    <button class="pin-key" onclick="pinPress('3')">3</button>
    <button class="pin-key" onclick="pinPress('4')">4</button>
    <button class="pin-key" onclick="pinPress('5')">5</button>
    <button class="pin-key" onclick="pinPress('6')">6</button>
    <button class="pin-key" onclick="pinPress('7')">7</button>
    <button class="pin-key" onclick="pinPress('8')">8</button>
    <button class="pin-key" onclick="pinPress('9')">9</button>
    <div></div>
    <button class="pin-key" onclick="pinPress('0')">0</button>
    <button class="pin-key pin-del" onclick="pinDel()">‚å´</button>
  </div>

  <div style="color:#2c2c2e;font-size:9px;letter-spacing:1px;margin-top:40px;">¬© 2025 OSCAR RIVAS ¬∑ BARTLETT'S RESTAURANT</div>
</div>

<style>
  .pin-dot {
    width:14px;height:14px;border-radius:50%;
    border:2px solid #3a3a3c;background:transparent;
    transition:background 0.15s;
  }
  .pin-dot.filled { background:#ef4444;border-color:#ef4444; }
  .pin-key {
    width:72px;height:64px;border-radius:16px;
    border:1.5px solid #2c2c2e;background:#1c1c1e;
    color:#f2f2f7;font-family:ui-monospace,'SF Mono','Courier New',monospace;
    font-size:22px;font-weight:600;cursor:pointer;
    transition:background 0.1s, transform 0.08s;
    -webkit-tap-highlight-color:transparent;
  }
  .pin-key:active { background:#2c2c2e;transform:scale(0.94); }
  .pin-del { font-size:18px;color:#636366; }
</style>
<div id="install-banner">
  <div class="ib-icon">üçÉ</div>
  <div class="ib-text">
    <div class="ib-title">INSTALL AS APP</div>
    <div class="ib-sub">Tap <strong>Share ‚Üë</strong> then <strong>"Add to Home Screen"</strong> for the full native experience</div>
  </div>
  <button class="ib-close" onclick="dismissInstall()">‚úï</button>
</div>

<div id="app">

  <!-- Top Bar -->
  <div id="topbar">
    <div>
      <div class="brand-name">BARTLETT'S</div>
      <div class="brand-sub">ORDER MANAGEMENT <span onclick="showWhatsNew()" style="color:#3a3a3c;font-size:8px;cursor:pointer;border-bottom:1px dotted #3a3a3c;">v1.5</span></div>
      <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:8px;color:#1c1c1e;letter-spacing:0.5px;margin-top:1px;">¬© 2025 Oscar Rivas</div>
    </div>
    <div class="topbar-right">
      <span class="date-chip" id="today-date"></span>
      <span id="sync-badge" title="Sync status" style="font-size:14px;cursor:default;">üìµ</span>
      <button class="btn-edit" id="btn-edit" onclick="toggleEditMode()">‚úé Edit</button>
      <button class="btn-save" id="btn-save" onclick="openSaveModal()">üíæ SAVE</button>
    </div>
  </div>

  <!-- Content -->
  <div id="content">

    <!-- ORDER VIEW -->
    <div id="view-order" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
      <div class="sup-tabs" id="sup-tabs"></div>
      <div class="sup-info" id="sup-info"></div>
      <div class="edit-banner" id="edit-banner" style="display:none;">
        <div>
          <div class="edit-banner-title">CATALOG EDIT MODE</div>
          <div class="edit-banner-sub">Tap any item to edit name, pack size, or par</div>
        </div>
        <button class="btn-done-edit" onclick="toggleEditMode()">‚úì Done Editing</button>
      </div>
      <div id="item-list"></div>
    </div>

    <!-- HISTORY VIEW -->
    <div id="view-history" style="flex:1;display:none;flex-direction:column;overflow:hidden;">
      <div class="filter-chips" id="filter-chips"></div>
      <div id="history-list"></div>
    </div>

    <!-- MUST KNOW VIEW -->
    <div id="view-mustknow" style="flex:1;display:none;flex-direction:column;overflow:hidden;">
      <div id="mustknow-scroll" style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;"></div>
    </div>

  </div>

  <!-- Copyright Footer -->
  <div style="background:#000;padding:3px 16px;text-align:center;flex-shrink:0;border-top:1px solid #111;">
    <span style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:7px;color:#2c2c2e;letter-spacing:0.8px;">
      ¬© 2025 OSCAR RIVAS ¬∑ BARTLETT'S RESTAURANT ¬∑ ALL RIGHTS RESERVED
    </span>
  </div>

  <!-- Tab Bar -->
  <div id="tabbar">
    <button class="tab-btn active" id="tab-order" onclick="switchTab('order')">
      <div class="tab-indicator"></div>
      <span class="tab-emoji">üìã</span>
      <span class="tab-label">Order</span>
    </button>
    <button class="tab-btn" id="tab-history" onclick="switchTab('history')">
      <span class="tab-emoji">üïê</span>
      <span class="tab-label">History</span>
    </button>
    <button class="tab-btn" id="tab-mustknow" onclick="switchTab('mustknow')">
      <span class="tab-emoji">üìå</span>
      <span class="tab-label">Must Know</span>
    </button>
  </div>

</div>

<!-- History Detail (full-screen overlay) -->
<div id="hist-detail">
  <div class="detail-header">
    <button class="btn-back" onclick="closeDetail()">‚Äπ</button>
    <div style="flex:1">
      <div id="detail-date" style="color:#f2f2f7;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;"></div>
      <div id="detail-meta" style="color:#636366;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;margin-top:1px;"></div>
    </div>
    <button class="btn-print-detail" id="btn-print-detail">üñ® Print</button>
  </div>
  <div id="detail-scroll"></div>
</div>

<!-- Save Modal -->
<div class="sheet-overlay" id="save-modal" style="display:none;" onclick="closeSaveModal()">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Save & Reset Order</div>
    <div class="sheet-sub">This saves everything to history and clears the sheet for the next order. All fields will be reset.</div>

    <!-- Delivery Date -->
    <div style="margin-bottom:20px;">
      <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;color:#a3a3a3;letter-spacing:1px;margin-bottom:10px;">üöö DELIVERY DATE</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="delivery-chips">
        <button class="del-chip active" onclick="selectDelivery(this,'next')" data-val="next">Tomorrow</button>
        <button class="del-chip" onclick="selectDelivery(this,'2day')" data-val="2day">In 2 days</button>
        <button class="del-chip" onclick="selectDelivery(this,'3day')" data-val="3day">In 3 days</button>
        <button class="del-chip" onclick="selectDelivery(this,'custom')" data-val="custom">Pick date‚Ä¶</button>
      </div>
      <input type="date" id="delivery-custom-date" style="
        display:none;margin-top:10px;width:100%;height:44px;padding:0 14px;
        border-radius:10px;border:2px solid #4ade80;background:#1c1c1e;
        color:#f2f2f7;font-family:ui-monospace,'SF Mono','Courier New',monospace;
        font-size:15px;outline:none;box-sizing:border-box;">
      <div id="delivery-display" style="
        margin-top:10px;font-family:ui-monospace,'SF Mono','Courier New',monospace;
        font-size:13px;color:#4ade80;min-height:18px;"></div>
    </div>

    <button class="btn-confirm" id="btn-confirm-save" onclick="doSave()">‚úì  CONFIRM SAVE & RESET</button>
    <button class="btn-cancel" onclick="closeSaveModal()">Cancel</button>
  </div>
</div>

<style>
  .del-chip {
    padding:8px 16px;border-radius:20px;border:1.5px solid #2c2c2e;
    background:#1c1c1e;color:#636366;
    font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;
    cursor:pointer;letter-spacing:0.5px;transition:all 0.15s;
  }
  .del-chip.active {
    border-color:#4ade80;background:#14532d;color:#4ade80;
  }
</style>

<!-- Edit Item Sheet -->
<div class="sheet-overlay" id="edit-sheet" style="display:none;" onclick="cancelEdit()">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Edit Item</div>
    <div id="edit-sheet-sup" style="color:#636366;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;letter-spacing:1px;margin-bottom:18px;"></div>
    <div class="edit-field-wrap">
      <div class="edit-field-label">ITEM NAME</div>
      <input class="edit-input" type="text" id="edit-name" autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
    <div class="edit-field-wrap">
      <div class="edit-field-label">PACK / CASE SIZE</div>
      <input class="edit-input" type="text" id="edit-pack" autocomplete="off">
    </div>
    <div class="edit-field-wrap" style="margin-bottom:22px;">
      <div class="edit-field-label">PAR LEVEL</div>
      <input class="edit-input" type="number" inputmode="decimal" id="edit-par">
    </div>
    <button class="btn-confirm" onclick="commitEdit()">‚úì  SAVE CHANGES</button>
    <button class="btn-cancel" onclick="cancelEdit()">Cancel</button>
  </div>
</div>

<!-- Location Tally Modal -->
<div class="sheet-overlay" id="tally-modal" style="display:none;" onclick="closeTallyModal()">
  <div class="sheet" onclick="event.stopPropagation()" style="padding-bottom:max(24px,env(safe-area-inset-bottom));">
    <div class="sheet-handle"></div>
    <div id="tally-item-name" style="font-size:15px;font-weight:700;color:#e5e5e7;margin-bottom:2px;"></div>
    <div id="tally-item-sub" style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#636366;letter-spacing:1px;margin-bottom:20px;"></div>

    <!-- Location rows -->
    <div style="display:flex;flex-direction:column;gap:14px;margin-bottom:20px;">

      <!-- DOCK -->
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div>
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:12px;font-weight:700;color:#c084fc;letter-spacing:1px;">üö¢ DOCK</div>
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#48484a;margin-top:1px;">Receiving area ¬∑ separate with spaces</div>
          </div>
          <div id="tally-dock-sub" style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:18px;font-weight:700;color:#a78bfa;min-width:36px;text-align:right;">0</div>
        </div>
        <input id="tally-dock" type="text" inputmode="decimal" placeholder="e.g. 8  2  3  2"
          style="width:100%;box-sizing:border-box;height:46px;padding:0 14px;border-radius:10px;border:2px solid #3b0764;background:#1c1c1e;color:#c084fc;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:18px;font-weight:700;outline:none;letter-spacing:2px;">
      </div>

      <!-- CLOSET -->
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div>
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:12px;font-weight:700;color:#c084fc;letter-spacing:1px;">üö™ CLOSET</div>
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#48484a;margin-top:1px;">Storage area ¬∑ separate with spaces</div>
          </div>
          <div id="tally-closet-sub" style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:18px;font-weight:700;color:#a78bfa;min-width:36px;text-align:right;">0</div>
        </div>
        <input id="tally-closet" type="text" inputmode="decimal" placeholder="e.g. 12  5"
          style="width:100%;box-sizing:border-box;height:46px;padding:0 14px;border-radius:10px;border:2px solid #3b0764;background:#1c1c1e;color:#c084fc;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:18px;font-weight:700;outline:none;letter-spacing:2px;">
      </div>

      <!-- RESTAURANT -->
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div>
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:12px;font-weight:700;color:#c084fc;letter-spacing:1px;">üçΩÔ∏è RESTAURANT</div>
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#48484a;margin-top:1px;">Floor + coolers ¬∑ separate with spaces</div>
          </div>
          <div id="tally-restaurant-sub" style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:18px;font-weight:700;color:#a78bfa;min-width:36px;text-align:right;">0</div>
        </div>
        <input id="tally-restaurant" type="text" inputmode="decimal" placeholder="e.g. 24  6"
          style="width:100%;box-sizing:border-box;height:46px;padding:0 14px;border-radius:10px;border:2px solid #3b0764;background:#1c1c1e;color:#c084fc;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:18px;font-weight:700;outline:none;letter-spacing:2px;">
      </div>

    </div>

    <!-- Total -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-top:1px solid #2c2c2e;border-bottom:1px solid #2c2c2e;margin-bottom:20px;">
      <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:14px;font-weight:700;color:#e5e5e7;letter-spacing:1px;">TOTAL COUNT</div>
      <div id="tally-total" style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:28px;font-weight:700;color:#a78bfa;">0</div>
    </div>

    <button class="btn-confirm" onclick="confirmTally()" style="background:#7c3aed;border-color:#7c3aed;">‚úì  SET COUNT</button>
    <button class="btn-cancel" onclick="closeTallyModal()">Cancel</button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_SUPPLIERS = {
  ABCO: {
    color:"#1e4d35", accent:"#4ade80",
    schedule:"Sun ¬∑ Wed ¬∑ Thu optional ‚Äî before 3pm",
    contact:"Hal Nouvealty ¬∑ 512-801-5422 ¬∑ SMS",
    items:[
      {id:"abco-1",name:"Cutlery kit - to go silverware",pack:"250 ct",par:1},
      {id:"abco-2",name:"2 gal Ziploc Bags",pack:"100 ct",par:2},
      {id:"abco-3",name:"12 inch film",pack:"each",par:1},
      {id:"abco-4",name:"18 inch film",pack:"each",par:1},
      {id:"abco-5",name:"Heavy Duty Foil 18 inch",pack:"each",par:1},
      {id:"abco-6",name:"Trash Can Liners",pack:"200 ct",par:2},
      {id:"abco-7",name:"8oz To go Soup cup",pack:"500 ct",par:1},
      {id:"abco-8",name:"Lids for To go soup",pack:"500 ct",par:1},
      {id:"abco-9",name:"To Go cups 16 oz",pack:"1000 ct",par:1},
      {id:"abco-10",name:"To Go cup LIDS 16 oz",pack:"1000 ct",par:1},
      {id:"abco-11",name:"3.25 oz portion Cups To Go",pack:"2500 ct",par:1},
      {id:"abco-12",name:"Lids for 3oz portion cups",pack:"2500 ct",par:1},
      {id:"abco-13",name:"12oz To Go Coffee cup",pack:"1200 ct",par:0.25},
      {id:"abco-14",name:"LIDS for to go coffee cups",pack:"1200 ct",par:0.25},
      {id:"abco-15",name:"#1 Bio Pak (small to go)",pack:"6/450",par:1},
      {id:"abco-16",name:"#3 Bio Pak (large to go)",pack:"4/50 ct",par:3},
      {id:"abco-17",name:"To Go Bags Royal 70#",pack:"200 ct",par:1},
      {id:"abco-18",name:"Traveler Bags",pack:"250 ct",par:1},
      {id:"abco-19",name:"Bistro Bags",pack:"250 ct",par:1},
      {id:"abco-20",name:"Filter machine filters (17.5\"x28\')",pack:"4 ct",par:1},
    ]
  },
  BEK: {
    color:"#0f172a", accent:"#60a5fa",
    schedule:"Sun ¬∑ Wed ¬∑ Fri ‚Äî before 4pm",
    contact:"BekEntree.com ¬∑ Bartletts@bartlettsaustin.com",
    items:[
      {id:"bek-1",name:"Metal bullets 3oz",pack:"12 ct",par:5},
      {id:"bek-2",name:"Birthday Candles",pack:"12/24",par:0.5},
      {id:"bek-3",name:"Thermometer Probe Wipes",pack:"200 ct",par:1},
      {id:"bek-4",name:"Coffee Filters 1.5 gal",pack:"500 ct",par:0.25},
      {id:"bek-5",name:'Patty Paper Square 5.5"',pack:"1000 ct",par:1},
      {id:"bek-6",name:"Poly Gloves Large",pack:"10/100",par:8},
      {id:"bek-7",name:"Poly Gloves Medium",pack:"10/100",par:2},
      {id:"bek-8",name:"Nitrile Gloves Large",pack:"10/100",par:4},
      {id:"bek-9",name:"Cheese Cloth",pack:"500 ft.",par:1},
      {id:"bek-10",name:"Liner Pan Paper",pack:"1000 ct",par:0.25},
      {id:"bek-11",name:'Wooden Skewers 4.5"',pack:"1000 ct",par:1},
      {id:"bek-12",name:"Foil sheets 12 x 10.75",pack:"200 ct",par:1},
      {id:"bek-13",name:"Use First Labels",pack:"‚Äî",par:1},
      {id:"bek-14",name:"Day dots - MONDAY",pack:"1000 ROLL",par:1},
      {id:"bek-15",name:"Day dots - TUESDAY",pack:"1000 ROLL",par:1},
      {id:"bek-16",name:"Day dots - WEDNESDAY",pack:"1000 ROLL",par:1},
      {id:"bek-17",name:"Day dots - THURSDAY",pack:"1000 ROLL",par:1},
      {id:"bek-18",name:"Day dots - FRIDAY",pack:"1000 ROLL",par:1},
      {id:"bek-19",name:"Day dots - SATURDAY",pack:"1000 ROLL",par:1},
      {id:"bek-20",name:"Day dots - SUNDAY",pack:"1000 ROLL",par:1},
      {id:"bek-21",name:"Day dots - Large Label",pack:"500 ct",par:2},
      {id:"bek-22",name:"Portion Bags - essential",pack:"2000 ct",par:1},
      {id:"bek-23",name:"Hand soap Safeguard",pack:"2/1gal",par:1},
      {id:"bek-24",name:"Hand Soap (orange)",pack:"4/750ml",par:4},
      {id:"bek-25",name:"Hand Sanitizer (clear)",pack:"4/750ml",par:4},
      {id:"bek-26",name:"Glass Cleaner",pack:"12/32 oz",par:2},
      {id:"bek-27",name:"Oven Cleaner",pack:"8 ct",par:4},
      {id:"bek-28",name:"Green Scrub pads",pack:"20 ct",par:1},
      {id:"bek-29",name:"Z fold paper towels",pack:"12/120 ct",par:1},
      {id:"bek-30",name:"Charmin toilet paper",pack:"60ct",par:1},
      {id:"bek-31",name:"Towel Roll non Perf 7.75 Wht",pack:"6/700 ft",par:4},
      {id:"bek-32",name:"Toilet Seat Covers",pack:"20/250",par:2},
      {id:"bek-33",name:"Bag paper sanitary recept",pack:"250 ct",par:0.5},
      {id:"bek-34",name:"Clear straw wrapped",pack:"1/400",par:4},
      {id:"bek-35",name:"Brown paper bag 8#",pack:"500 ea",par:0.25},
      {id:"bek-36",name:"1 comp to go black 11x8",pack:"100 ct",par:2},
      {id:"bek-37",name:"2 comp to go black 11x8",pack:"100 ct",par:2},
      {id:"bek-38",name:"salad to go large 9x3",pack:"100 ct",par:2},
      {id:"bek-39",name:"salad to go small 6x2.5",pack:"200 ct",par:1},
      {id:"bek-40",name:"Lemon Wraps",pack:"10/100ct",par:2},
      {id:"bek-41",name:"Bleach",pack:"6/1 gl",par:2},
      {id:"bek-42",name:"Ajax cleanser",pack:"24 ct",par:2},
      {id:"bek-43",name:"Plastic Aprons",pack:"6ct",par:1},
      {id:"bek-44",name:"Mop Head",pack:"3 ct",par:2},
      {id:"bek-45",name:"Water Softener Salt",pack:"1 lb",par:5},
      {id:"bek-46",name:"Fryer Oil (Wed/Thu dump)",pack:"each",par:10},
    ]
  },
  AMAZON: {
    color:"#7c2d12", accent:"#fb923c",
    schedule:"As needed ‚Äî check weekly",
    contact:"bartletts@bartlettsaustin.com ¬∑ 2408Anderson!",
    items:[
      {id:"amz-1",name:"Mineral oil",pack:"1 gallon",par:2},
      {id:"amz-2",name:"Lexol Leather conditioner",pack:"3 Liters",par:1},
      {id:"amz-3",name:"Minwax paste finishing wax",pack:"1 lb",par:1},
      {id:"amz-4",name:"Max tight isopropyl Alcohol",pack:"4 gallon",par:1},
      {id:"amz-5",name:"Dental floss picks",pack:"200 ct",par:4},
      {id:"amz-6",name:"Chicco Caddy High chair",pack:"1 chair",par:6},
      {id:"amz-7",name:'E-Gtong 9" Spring mold pan',pack:"1 pan",par:6},
      {id:"amz-8",name:"Tenagoo tea cup Charcoal gray",pack:"4/pack",par:24},
      {id:"amz-9",name:'Sweetjar ceramic Pie pan 10"',pack:"1/pack",par:24},
      {id:"amz-10",name:'Honeydak Extra long gloves 27.5"',pack:"2/pack",par:1},
      {id:"amz-11",name:'Blue rubber bandaid 1"x 3"',pack:"1500/pack",par:1},
      {id:"amz-12",name:"Blue Nitrol finger cots",pack:"144/pack",par:1},
      {id:"amz-13",name:"Jasai 18oz clear soap dispenser",pack:"1/pack",par:1},
      {id:"amz-14",name:"Shark rechargeable carpet sweeper",pack:"1 vacuum",par:1},
      {id:"amz-15",name:"Rubbermaid 4 comp. plastic cutlery bin",pack:"1 pack",par:6},
    ]
  },
  ELECTRICAL: {
    color:"#1a1a2e", accent:"#f59e0b",
    schedule:"As needed",
    contact:"",
    email:"",
    vendorName:"",
    items:[
      {id:"elc-1", name:"10W Clear Halogen Bulb 12V (G4 12V 10W)",          pack:"each", par:4,  location:"MB/SB"},
      {id:"elc-2", name:"35W Clear Halogen Bulb GY6.35 12V",                pack:"each", par:4,  location:"81-86"},
      {id:"elc-3", name:"35W Frosted Xenon Bulb (G9 120V 25W)",             pack:"each", par:4,  location:"50-57"},
      {id:"elc-4", name:"SORAA Vivid MR16 10¬∞ NSP 7.5W 2700K",             pack:"each", par:6,  location:"Host/Wattstation"},
      {id:"elc-5", name:"LED 10P20D27KFL TCP 10W 2700K",                    pack:"each", par:8,  location:"Emp closet hall"},
      {id:"elc-6", name:"GE Q20MR16/CG15Degree",                            pack:"each", par:2,  location:"Archway lights"},
      {id:"elc-7", name:"Sylvania Halogen Par 16 GE Brand Only",            pack:"each", par:2,  location:"Hallway art"},
      {id:"elc-8", name:"Green Creative Titanium LED PAR30-E26-13W-3000K-40¬∞", pack:"each", par:3, location:"Outside canister/50's"},
      {id:"elc-9", name:"GE Q20MR16C/CG 40 Degree (BAB/CG)",               pack:"each", par:3,  location:"Walkway/Stake lights"},
      {id:"elc-10",name:"60W A19 Silver Bulb LED TCP 10.5W 850lm (LED12BR30D27K)", pack:"each", par:2, location:"Small patio/Exit doors"},
      {id:"elc-11",name:"GE 300 Par56/MFL 130V 330W (GE#6068.90)",         pack:"each", par:6,  location:"Tree lights"},
      {id:"elc-12",name:"GE 300 Par56/MFL Car Lamps",                       pack:"each", par:2,  location:"Car lamps"},
    ]
  },
    color:"#3b0764", accent:"#c084fc",
    schedule:"Monthly ‚Äî after inventory",
    contact:"James Hawley ¬∑ James.Hawley@trimarkusa.com",
    items:[
      {id:"tri-1", name:"Rocks glasses",       pack:"case", par:72,  unitCost:9.59},
      {id:"tri-2", name:"Collins glasses",      pack:"case", par:72,  unitCost:9.59},
      {id:"tri-3", name:"Beer Glass",           pack:"case", par:48,  unitCost:5.17},
      {id:"tri-4", name:"Tea Glass",            pack:"case", par:400, unitCost:3.54},
      {id:"tri-5", name:"Champagne glasses",    pack:"case", par:36,  unitCost:12.27},
      {id:"tri-6", name:"Martini glasses",      pack:"case", par:100, unitCost:9.38},
      {id:"tri-7", name:"Cordial glasses",      pack:"case", par:24,  unitCost:3.42},
      {id:"tri-8", name:"Brandy snifters",      pack:"case", par:12,  unitCost:2.47},
      {id:"tri-9", name:"Port wine glasses",    pack:"case", par:12,  unitCost:5.40},
      {id:"tri-10",name:"Whiskey glasses",      pack:"case", par:12,  unitCost:11.25},
      {id:"tri-11",name:"Wine glasses",         pack:"case", par:124, unitCost:5.77},
      {id:"tri-12",name:"Espresso Cup",         pack:"case", par:12,  unitCost:2.05},
      {id:"tri-13",name:"Espresso Saucer",      pack:"case", par:12,  unitCost:0.80},
      {id:"tri-14",name:"Cappuccino cup",       pack:"case", par:60,  unitCost:1.01},
      {id:"tri-15",name:"Cappuccino saucer",    pack:"case", par:48,  unitCost:0.80},
      {id:"tri-16",name:"Latte Cup",            pack:"case", par:24,  unitCost:15.94},
      {id:"tri-17",name:"Latte Saucer",         pack:"case", par:12,  unitCost:0.80},
      {id:"tri-18",name:"Coffee Mugs",          pack:"case", par:48,  unitCost:2.44},
      {id:"tri-19",name:'Salad Plate 11"',      pack:"case", par:100, unitCost:29.04},
      {id:"tri-20",name:"Chksal bowls",         pack:"case", par:72,  unitCost:18.91},
      {id:"tri-21",name:"Bird bowl",            pack:"case", par:56,  unitCost:32.17},
      {id:"tri-22",name:'Ala plate 10"',        pack:"case", par:150, unitCost:20.62},
      {id:"tri-23",name:"Platter plates",       pack:"case", par:100, unitCost:38.96},
      {id:"tri-24",name:"Thai plates",          pack:"case", par:60,  unitCost:27.67},
      {id:"tri-25",name:"Soup bowl",            pack:"case", par:84,  unitCost:8.59},
      {id:"tri-26",name:"Chili bowl",           pack:"case", par:36,  unitCost:5.50},
      {id:"tri-27",name:"Spin bowl",            pack:"case", par:84,  unitCost:9.08},
      {id:"tri-28",name:"Gravy Boats",          pack:"case", par:24,  unitCost:34.46},
      {id:"tri-29",name:'Key Lime pie plate',   pack:"case", par:24,  unitCost:34.99},
      {id:"tri-30",name:"Metal ramekin",        pack:"case", par:72,  unitCost:7.48},
      {id:"tri-31",name:"Tip plate",            pack:"case", par:250, unitCost:3.29},
      {id:"tri-32",name:"Fork",                 pack:"case", par:500, unitCost:3.08},
      {id:"tri-33",name:"Knife",                pack:"case", par:500, unitCost:4.25},
      {id:"tri-34",name:"Steak knife",          pack:"case", par:50,  unitCost:14.92},
      {id:"tri-35",name:"Spoon",                pack:"case", par:144, unitCost:2.34},
      {id:"tri-36",name:"Iced tea spoons",      pack:"case", par:144, unitCost:1.97},
      {id:"tri-37",name:"Coffee spoons",        pack:"case", par:48,  unitCost:1.49},
      {id:"tri-38",name:"S & P mills",          pack:"each", par:60,  unitCost:46.00},
      {id:"tri-39",name:"Waiter Aprons",        pack:"each", par:5,   unitCost:37.00},
      {id:"tri-40",name:"Chefs hats",           pack:"each", par:15,  unitCost:13.00},
      {id:"tri-41",name:"Pate Knives",          pack:"each", par:36,  unitCost:10.22},
    ]
  }
};

const SUP_NAMES = Object.keys(DEFAULT_SUPPLIERS);

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  tab: 'order',
  activeSupp: 'ABCO',
  onHand: {},
  orderQty: {},
  itemNotes: {},
  globalNote: '',
  editMode: false,
  editingItem: null,
  history: [],
  selectedRec: null,
  filterSup: 'ALL',
  catalog: JSON.parse(JSON.stringify(DEFAULT_SUPPLIERS)),
  breakage: {},           // tri item id ‚Üí qty broken this month
  trimarkBegin: {},       // tri item id ‚Üí beginning inventory count
  trimarkView: 'order',   // 'order' | 'inventory'
  trimarkTally: {},        // tri item id ‚Üí {dock, closet, restaurant}
};

// ‚îÄ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function lsGet(k) { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } }
function lsSet(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} }

// ‚îÄ‚îÄ‚îÄ FIREBASE SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FB_CONFIG = {
  databaseURL: "https://bartletts-rest-op-default-rtdb.firebaseio.com"
};
let fbDb = null;
let fbSyncStatus = 'offline'; // 'offline' | 'syncing' | 'synced' | 'error'

function initFirebase() {
  // If firebase SDK hasn't loaded yet (e.g. slow network), retry after delay
  if (typeof firebase === 'undefined') {
    console.warn('Firebase SDK not loaded yet, retrying in 2s‚Ä¶');
    fbSyncStatus = 'syncing';
    updateSyncBadge();
    setTimeout(initFirebase, 2000);
    return;
  }
  try {
    if (!firebase.apps.length) firebase.initializeApp(FB_CONFIG);
    fbDb = firebase.database();
    // Listen for history changes from any device
    fbDb.ref('history').on('value', snap => {
      const data = snap.val();
      if (data) {
        const incoming = Object.values(data).sort((a,b) => new Date(b.date) - new Date(a.date));
        // Merge with local ‚Äî keep all unique by date+id
        const merged = mergeHistory(state.history, incoming);
        state.history = merged;
        lsSet('bartletts-orders-v3', state.history);
        if (state.tab === 'history') renderHistoryView();
      }
      fbSyncStatus = 'synced';
      updateSyncBadge();
    }, err => {
      console.warn('Firebase sync error:', err);
      fbSyncStatus = 'error';
      updateSyncBadge();
    });
    fbSyncStatus = 'syncing';
    updateSyncBadge();
  } catch(e) {
    console.warn('Firebase init failed:', e);
    fbSyncStatus = 'error';
    updateSyncBadge();
  }
}

function mergeHistory(local, remote) {
  const map = new Map();
  [...local, ...remote].forEach(r => {
    const key = r.id || r.date;
    if (!map.has(key)) map.set(key, r);
  });
  return Array.from(map.values()).sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 365);
}

function fbSaveRecord(rec) {
  if (!fbDb) return;
  // Use a sanitized key from the date
  const key = 'rec_' + new Date(rec.date).getTime();
  rec.id = rec.id || key;
  fbDb.ref('history/' + rec.id).set(rec).catch(e => console.warn('FB save error:', e));
}

function updateSyncBadge() {
  const el = document.getElementById('sync-badge');
  if (!el) return;
  const icons = { offline:'üìµ', syncing:'üîÑ', synced:'‚òÅÔ∏è', error:'‚ö†Ô∏è' };
  const colors = { offline:'#48484a', syncing:'#fbbf24', synced:'#4ade80', error:'#f87171' };
  el.textContent = icons[fbSyncStatus];
  el.title = { offline:'Offline', syncing:'Connecting‚Ä¶', synced:'Synced across devices', error:'Sync error' }[fbSyncStatus];
  el.style.color = colors[fbSyncStatus];
}

function loadPersistedData() {
  const hist = lsGet('bartletts-orders-v3');
  if (hist) state.history = hist;

  const cat = lsGet('bartletts-catalog-v1');
  if (cat) {
    for (const sn of SUP_NAMES) {
      if (cat[sn]?.items) state.catalog[sn].items = cat[sn].items;
    }
  }

  const brk = lsGet('bartletts-breakage-v1');
  if (brk) state.breakage = brk;
  const beg = lsGet('bartletts-trimark-begin-v1');
  if (beg) {
    state.trimarkBegin = beg;
  } else {
    // Pre-loaded from December 2025 ending counts (breakage report)
    state.trimarkBegin = {
      'tri-1':  97,   // Rocks glasses
      'tri-2':  100,  // Collins glasses
      'tri-3':  99,   // Beer Glass
      'tri-4':  439,  // Tea Glass
      'tri-5':  46,   // Champagne glasses
      'tri-6':  161,  // Martini glasses
      'tri-7':  53,   // Cordial glasses
      'tri-8':  31,   // Brandy snifters
      'tri-9':  33,   // Port wine glasses
      'tri-10': 22,   // Whiskey glasses
      'tri-11': 160,  // Wine glasses
      'tri-12': 14,   // Espresso Cup
      'tri-13': 9,    // Espresso Saucer
      'tri-14': 85,   // Cappuccino cup
      'tri-15': 92,   // Cappuccino saucer
      'tri-16': 20,   // Latte Cup
      'tri-17': 15,   // Latte Saucer
      'tri-18': 66,   // Coffee Mugs
      'tri-19': 155,  // Salad Plate 11"
      'tri-20': 108,  // Chksal bowls
      'tri-21': 98,   // Bird bowl
      'tri-22': 190,  // Ala plate 10"
      'tri-23': 124,  // Platter plates
      'tri-24': 74,   // Thai plates
      'tri-25': 94,   // Soup bowl
      'tri-26': 77,   // Chili bowl
      'tri-27': 102,  // Spin bowl
      'tri-28': 37,   // Gravy Boats
      'tri-29': 30,   // Key Lime pie plate
      'tri-30': 108,  // Metal ramekin
      'tri-31': 413,  // Tip plate
      'tri-32': 593,  // Fork
      'tri-33': 612,  // Knife
      'tri-34': 91,   // Steak knife
      'tri-35': 127,  // Spoon
      'tri-36': 165,  // Iced tea spoons
      'tri-37': 68,   // Coffee spoons
      'tri-38': 86,   // S & P mills
      'tri-39': 33,   // Waiter Aprons
      'tri-40': 30,   // Chefs hats
      'tri-41': 39,   // Pate Knives
    };
    saveTrimarkBegin();
  }
  const tal = lsGet('bartletts-trimark-tally-v1');
  if (tal) state.trimarkTally = tal;
}

function saveBreakage() {
  lsSet('bartletts-breakage-v1', state.breakage);
}

function saveTrimarkBegin() {
  lsSet('bartletts-trimark-begin-v1', state.trimarkBegin);
}

function saveTrimarkTally() {
  lsSet('bartletts-trimark-tally-v1', state.trimarkTally);
}

function saveCatalog() {
  const toStore = {};
  for (const sn of SUP_NAMES) toStore[sn] = { items: state.catalog[sn].items };
  lsSet('bartletts-catalog-v1', toStore);
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ikey(sn, id) { return sn + '|' + id; }

function getStatus(oh, par) {
  const h = parseFloat(oh), p = parseFloat(par);
  if (oh === '' || oh == null || isNaN(h)) return null;
  if (h <= 0) return 'critical';
  if (!isNaN(p) && h < p) return 'low';
  return 'ok';
}

const STATUS_ICONS = { critical:'üî¥', low:'üü°', ok:'üü¢' };

let toastTimer = null;
function showToast(msg, type='ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show' + (type !== 'ok' ? ' ' + type : '');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ''; }, 3000);
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  renderTopBar();
  if (state.tab === 'order') renderOrderView();
  else if (state.tab === 'history') renderHistoryView();
  else if (state.tab === 'mustknow') renderMustKnow();
  renderTabBar();
}

function renderTopBar() {
  document.getElementById('today-date').textContent =
    new Date().toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});

  const btnEdit = document.getElementById('btn-edit');
  const btnSave = document.getElementById('btn-save');

  if (state.tab === 'order') {
    btnEdit.style.display = 'flex';
    btnSave.style.display = state.editMode ? 'none' : 'flex';
    btnEdit.className = 'btn-edit' + (state.editMode ? ' active' : '');
    btnEdit.textContent = state.editMode ? '‚úé Editing' : '‚úé Edit';
  } else {
    btnEdit.style.display = 'none';
    btnSave.style.display = 'none';
  }
}

function renderTabBar() {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const activeTab = document.getElementById('tab-' + state.tab);
  if (activeTab) activeTab.classList.add('active');
  const ind = activeTab?.querySelector('.tab-indicator');
  document.querySelectorAll('.tab-indicator').forEach(i => i.remove());
  if (activeTab) {
    const d = document.createElement('div');
    d.className = 'tab-indicator';
    activeTab.prepend(d);
  }
}

// ‚îÄ‚îÄ‚îÄ ORDER VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOrderView() {
  document.getElementById('view-order').style.display = 'flex';
  document.getElementById('view-history').style.display = 'none';
  document.getElementById('view-mustknow').style.display = 'none';

  const sup = state.catalog[state.activeSupp];
  const defSup = DEFAULT_SUPPLIERS[state.activeSupp];

  // Supplier tabs
  const tabsEl = document.getElementById('sup-tabs');
  tabsEl.innerHTML = '';
  for (const sn of SUP_NAMES) {
    const s = state.catalog[sn];
    const active = sn === state.activeSupp;
    const cnt = s.items.filter(i => (state.onHand[ikey(sn, i.id)] ?? '') !== '').length;
    const btn = document.createElement('button');
    btn.className = 'sup-tab' + (active ? ' active' : '');
    btn.style.cssText = `border-color:${active ? s.accent : '#2c2c2e'};background:${active ? s.color : '#1c1c1e'}`;
    btn.innerHTML = sn + (cnt > 0 ? `<span class="sup-tab-badge" style="background:${s.accent};color:#000">${cnt}</span>` : '');
    btn.onclick = () => {
      state.activeSupp = sn;
      state.trimarkView = 'order'; // always start on order view when switching suppliers
      render();
      document.getElementById('item-list').scrollTop = 0;
    };
    tabsEl.appendChild(btn);
  }

  // Sup info
  const crit = sup.items.filter(i => getStatus(state.onHand[ikey(state.activeSupp, i.id)] ?? '', i.par) === 'critical').length;
  const low  = sup.items.filter(i => getStatus(state.onHand[ikey(state.activeSupp, i.id)] ?? '', i.par) === 'low').length;
  const infoEl = document.getElementById('sup-info');
  infoEl.style.background = sup.color;

  // For Trimark: show inventory toggle button
  const trimarkBtn = state.activeSupp === 'TRIMARK' ? `
    <button onclick="toggleTrimarkView()" style="
      margin-top:8px;padding:6px 14px;border-radius:20px;border:1.5px solid #c084fc;
      background:${state.trimarkView==='inventory'?'#c084fc':'transparent'};
      color:${state.trimarkView==='inventory'?'#000':'#c084fc'};
      font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;letter-spacing:0.5px;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;">
      üìã INVENTORY COUNT
    </button>` : '';

  // For ELECTRICAL: show vendor info + edit button
  const elcSup = state.catalog['ELECTRICAL'] || DEFAULT_SUPPLIERS['ELECTRICAL'];
  const electricalInfo = state.activeSupp === 'ELECTRICAL' ? `
    <div style="margin-top:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:rgba(255,255,255,0.5);">
        ${elcSup.vendorName ? 'üè¢ '+elcSup.vendorName : '‚ö†Ô∏è No vendor set'} 
        ${elcSup.email ? ' ¬∑ üìß '+elcSup.email : ' ¬∑ No email set'}
      </div>
      <button onclick="openElectricalVendorEdit()" style="
        padding:3px 10px;border-radius:12px;border:1px solid #f59e0b;
        background:transparent;color:#f59e0b;
        font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;font-weight:700;
        cursor:pointer;">‚úé EDIT VENDOR</button>
    </div>` : '';

  infoEl.innerHTML = `
    <div class="sup-info-sched">üìÖ ${defSup.schedule}</div>
    <div class="sup-info-contact">${defSup.contact}</div>
    ${trimarkBtn}${electricalInfo}
    ${!state.editMode && (crit > 0 || low > 0) ? `<div class="sup-info-alerts">
      ${crit > 0 ? `<span style="color:#f87171;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px">üî¥ ${crit} critical</span>` : ''}
      ${low  > 0 ? `<span style="color:#fbbf24;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px">üü° ${low} low</span>` : ''}
    </div>` : ''}
    ${state.editMode ? `<div style="color:#fbbf24;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;margin-top:4px">‚úé Tap any item to edit name, pack size, or par</div>` : ''}
  `;

  // Edit banner
  document.getElementById('edit-banner').style.display = state.editMode ? 'flex' : 'none';

  // Items
  const listEl = document.getElementById('item-list');
  listEl.innerHTML = '';

  // Trimark inventory sub-view
  if (state.activeSupp === 'TRIMARK' && state.trimarkView === 'inventory') {
    renderTrimarkInventory(listEl, sup);
    return;
  }

  sup.items.forEach(item => {
    const ik  = ikey(state.activeSupp, item.id);
    const oh  = state.onHand[ik] ?? '';
    const oq  = state.orderQty[ik] ?? '';
    const nt  = state.itemNotes[ik] ?? '';
    const st  = getStatus(oh, item.par);
    const rowBg = st === 'critical' ? 'rgba(248,113,113,0.09)' : st === 'low' ? 'rgba(251,191,36,0.07)' : 'transparent';

    const row = document.createElement('div');
    row.className = 'item-row';
    row.style.background = rowBg;

    // Inner
    const inner = document.createElement('div');
    inner.className = 'item-row-inner';

    if (state.editMode) {
      const editBtn = document.createElement('button');
      editBtn.className = 'edit-item-btn';
      editBtn.innerHTML = '‚úé';
      editBtn.onclick = () => startEdit(state.activeSupp, item);
      inner.appendChild(editBtn);
    }

    // Name col
    const nameCol = document.createElement('div');
    nameCol.style.cssText = 'flex:1;min-width:0';
    // Show begin count as a tag in order view for Trimark
    const beginVal = state.trimarkBegin[item.id];
    const endingVal = state.onHand[ikey('TRIMARK', item.id)] ?? '';
    const usageVal = (state.activeSupp === 'TRIMARK' && beginVal !== undefined && endingVal !== '') ? (parseFloat(beginVal)||0) - (parseFloat(endingVal)||0) : null;
    const brkDisplay = (state.activeSupp === 'TRIMARK' && !state.editMode && beginVal !== undefined)
      ? `<span style="color:#a78bfa;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;margin-left:6px">beg:${beginVal}${usageVal!==null?' used:'+usageVal:''}</span>` : '';
    nameCol.innerHTML = `
      <div class="item-name">${item.name}${brkDisplay}</div>
      <div class="item-meta">
        <span>${item.pack}</span><span style="color:#2c2c2e">¬∑</span>
        <span>par <span ${state.editMode ? 'style="color:#fbbf24"' : ''}>${item.par}</span></span>
      </div>`;
    inner.appendChild(nameCol);

    if (!state.editMode) {
      // On Hand input
      const ohCol = document.createElement('div');
      ohCol.className = 'inp-col';
      ohCol.innerHTML = `<span class="inp-label">ON HAND</span>`;
      const ohInp = document.createElement('input');
      ohInp.type = 'number'; ohInp.inputMode = 'decimal';
      ohInp.className = 'inp-field';
      ohInp.value = oh; ohInp.placeholder = '‚Äî';
      ohInp.style.borderColor = oh !== '' ? sup.accent : '#2c2c2e';
      ohInp.addEventListener('input', e => {
        state.onHand[ik] = e.target.value;
        // Live update row bg and status
        const newSt = getStatus(e.target.value, item.par);
        row.style.background = newSt === 'critical' ? 'rgba(248,113,113,0.09)' : newSt === 'low' ? 'rgba(251,191,36,0.07)' : 'transparent';
        ohInp.style.borderColor = e.target.value !== '' ? sup.accent : '#2c2c2e';
        // Update status icon
        const sIcon = inner.querySelector('.status-icon');
        if (sIcon) sIcon.textContent = newSt ? STATUS_ICONS[newSt] : '';
        // ‚îÄ‚îÄ AUTO-FILL ORDER QTY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Only auto-fill if the user hasn't manually typed a qty yet
        const ohVal = parseFloat(e.target.value);
        const parVal = parseFloat(item.par);
        if (!isNaN(ohVal) && !isNaN(parVal) && e.target.value !== '') {
          // For Trimark: order = par - ending + (begin - ending = usage portion to restore)
          // Actually: order = par - ending (simple par-based ordering; usage is tracked separately)
          const suggested = Math.max(0, parVal - ohVal);
          // Round to sensible precision (whole numbers unless par is fractional)
          const rounded = parVal % 1 === 0 ? Math.ceil(suggested) : Math.round(suggested * 4) / 4;
          const currentOq = state.orderQty[ik] ?? '';
          // Only fill if field is empty or was previously auto-filled (not manually edited)
          if (currentOq === '' || state._autoFilled?.[ik]) {
            state.orderQty[ik] = rounded > 0 ? String(rounded) : '';
            if (!state._autoFilled) state._autoFilled = {};
            state._autoFilled[ik] = true;
            // Update the order qty input visually
            const oqInp = inner.querySelector('.oq-input');
            if (oqInp) {
              const v = state.orderQty[ik];
              oqInp.value = v;
              oqInp.style.borderColor = v ? '#f97316' : '#2c2c2e';
              oqInp.style.color = v ? '#f97316' : '#fff';
              oqInp.style.fontWeight = v ? '700' : '400';
            }
          }
        } else if (e.target.value === '') {
          // Cleared on-hand ‚Äî clear auto-filled order qty too
          if (state._autoFilled?.[ik]) {
            state.orderQty[ik] = '';
            delete state._autoFilled[ik];
            const oqInp = inner.querySelector('.oq-input');
            if (oqInp) { oqInp.value = ''; oqInp.style.borderColor='#2c2c2e'; oqInp.style.color='#fff'; oqInp.style.fontWeight='400'; }
          }
        }
        // Update tab badge
        updateTabBadge(state.activeSupp);
        updateSupInfo();
      });
      ohCol.appendChild(ohInp);
      inner.appendChild(ohCol);

      // Order qty input
      const oqCol = document.createElement('div');
      oqCol.className = 'inp-col';
      oqCol.innerHTML = `<span class="inp-label">ORDER</span>`;
      const oqInp = document.createElement('input');
      oqInp.type = 'number'; oqInp.inputMode = 'decimal';
      oqInp.className = 'inp-field oq-input';
      oqInp.value = oq; oqInp.placeholder = '‚Äî';
      oqInp.style.cssText = `border-color:${oq !== '' ? '#f97316' : '#2c2c2e'};color:${oq !== '' ? '#f97316' : '#fff'};font-weight:${oq !== '' ? 700 : 400}`;
      oqInp.addEventListener('input', e => {
        state.orderQty[ik] = e.target.value;
        // Mark as manually edited ‚Äî autofill won't override this
        if (!state._autoFilled) state._autoFilled = {};
        if (e.target.value !== '') {
          state._autoFilled[ik] = false; // false = manual edit
        } else {
          delete state._autoFilled[ik];
        }
        const v = e.target.value;
        oqInp.style.borderColor = v ? '#f97316' : '#2c2c2e';
        oqInp.style.color = v ? '#f97316' : '#fff';
        oqInp.style.fontWeight = v ? '700' : '400';
      });
      oqCol.appendChild(oqInp);
      inner.appendChild(oqCol);

      // Status + note
      const rightCol = document.createElement('div');
      rightCol.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:4px;width:34px';
      const sIcon = document.createElement('span');
      sIcon.className = 'status-icon';
      sIcon.style.fontSize = '16px';
      sIcon.textContent = st ? STATUS_ICONS[st] : '';
      const noteBtn = document.createElement('button');
      noteBtn.className = 'note-btn' + (nt ? ' has-note' : '');
      noteBtn.innerHTML = '‚úé';
      noteBtn.onclick = () => toggleNoteDrawer(row, ik, nt);
      rightCol.appendChild(sIcon);
      rightCol.appendChild(noteBtn);
      inner.appendChild(rightCol);
    }

    row.appendChild(inner);

    // ‚îÄ‚îÄ SWIPE TO CLEAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (!state.editMode) {
      const clearBtn = document.createElement('div');
      clearBtn.className = 'swipe-clear-btn';
      clearBtn.innerHTML = `<span style="font-size:18px">üóë</span><span>CLEAR</span>`;
      clearBtn.onclick = () => {
        state.onHand[ik] = '';
        state.orderQty[ik] = '';
        if (state._autoFilled) delete state._autoFilled[ik];
        inner.style.transform = 'translateX(0)';
        updateTabBadge(state.activeSupp);
        updateSupInfo();
        renderItems();
        showToast('Row cleared');
      };
      row.appendChild(clearBtn);

      let touchStartX = 0, touchStartY = 0, swiping = false;
      inner.addEventListener('touchstart', e => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        swiping = false;
      }, {passive:true});
      inner.addEventListener('touchmove', e => {
        const dx = e.touches[0].clientX - touchStartX;
        const dy = e.touches[0].clientY - touchStartY;
        if (!swiping && Math.abs(dy) > Math.abs(dx)) return; // vertical scroll
        swiping = true;
        if (dx < 0) {
          const clamp = Math.max(-80, dx);
          inner.style.transform = `translateX(${clamp}px)`;
        } else if (dx > 0 && inner.style.transform !== 'translateX(0px)') {
          inner.style.transform = `translateX(0)`;
        }
      }, {passive:true});
      inner.addEventListener('touchend', e => {
        const dx = e.changedTouches[0].clientX - touchStartX;
        if (dx < -50) {
          inner.style.transform = 'translateX(-80px)'; // snap open
        } else {
          inner.style.transform = 'translateX(0)'; // snap closed
        }
      });
      // Close swipe if another row opens
      inner.addEventListener('click', () => {
        if (inner.style.transform === 'translateX(-80px)') {
          inner.style.transform = 'translateX(0)';
        }
      });
    }

    // Note drawer (if open)
    if (!state.editMode && state._openNote === ik) {
      const drawer = document.createElement('div');
      drawer.className = 'note-drawer';
      const ta = document.createElement('textarea');
      ta.className = 'note-textarea';
      ta.rows = 2; ta.value = nt;
      ta.placeholder = 'Note for this item‚Ä¶';
      ta.addEventListener('input', e => { state.itemNotes[ik] = e.target.value; });
      drawer.appendChild(ta);
      row.appendChild(drawer);
      setTimeout(() => ta.focus(), 50);
    }

    listEl.appendChild(row);
  });

  // Global notes
  if (!state.editMode) {
    const notesArea = document.createElement('div');
    notesArea.className = 'global-notes-area';
    notesArea.innerHTML = `<div class="section-label"><span style="font-size:16px">üìù</span> ORDER NOTES</div>`;
    const ta = document.createElement('textarea');
    ta.className = 'global-textarea' + (state.globalNote ? ' has-content' : '');
    ta.rows = 4; ta.value = state.globalNote;
    ta.placeholder = 'General notes, reminders, follow-ups‚Ä¶';
    ta.addEventListener('input', e => {
      state.globalNote = e.target.value;
      ta.className = 'global-textarea' + (e.target.value ? ' has-content' : '');
    });
    notesArea.appendChild(ta);
    listEl.appendChild(notesArea);
  }

  const spacer = document.createElement('div');
  spacer.className = 'safe-bottom';
  listEl.appendChild(spacer);
}

function toggleNoteDrawer(row, ik, currentNote) {
  if (state._openNote === ik) {
    state._openNote = null;
  } else {
    state._openNote = ik;
  }
  renderOrderView();
}

function updateTabBadge(sn) {
  const s = state.catalog[sn];
  const cnt = s.items.filter(i => (state.onHand[ikey(sn, i.id)] ?? '') !== '').length;
  // Find and update this tab's badge
  const tabs = document.querySelectorAll('.sup-tab');
  tabs.forEach(t => {
    if (t.textContent.trim().startsWith(sn)) {
      const badge = t.querySelector('.sup-tab-badge');
      if (cnt > 0) {
        if (!badge) {
          const b = document.createElement('span');
          b.className = 'sup-tab-badge';
          b.style.cssText = `background:${s.accent};color:#000`;
          b.textContent = cnt;
          t.appendChild(b);
        } else badge.textContent = cnt;
      } else if (badge) badge.remove();
    }
  });
}

function updateSupInfo() {
  const sup = state.catalog[state.activeSupp];
  const defSup = DEFAULT_SUPPLIERS[state.activeSupp];
  const crit = sup.items.filter(i => getStatus(state.onHand[ikey(state.activeSupp, i.id)] ?? '', i.par) === 'critical').length;
  const low  = sup.items.filter(i => getStatus(state.onHand[ikey(state.activeSupp, i.id)] ?? '', i.par) === 'low').length;
  const alertsEl = document.querySelector('.sup-info-alerts');
  if (alertsEl) alertsEl.remove();
  const infoEl = document.getElementById('sup-info');
  if (!state.editMode && (crit > 0 || low > 0)) {
    const d = document.createElement('div');
    d.className = 'sup-info-alerts';
    d.innerHTML = `
      ${crit > 0 ? `<span style="color:#f87171;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px">üî¥ ${crit} critical</span>` : ''}
      ${low  > 0 ? `<span style="color:#fbbf24;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px">üü° ${low} low</span>` : ''}`;
    infoEl.appendChild(d);
  }
}

// ‚îÄ‚îÄ‚îÄ TRIMARK INVENTORY VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTrimarkView() {
  state.trimarkView = state.trimarkView === 'inventory' ? 'order' : 'inventory';
  renderOrderView();
  document.getElementById('item-list').scrollTop = 0;
}

function getTrimarkSummary(sup) {
  // Compute totals for the summary bar
  let totalUsage = 0, totalBrkgCost = 0, needsOrder = 0;
  sup.items.forEach(item => {
    const ik = ikey('TRIMARK', item.id);
    const begVal = parseFloat(state.trimarkBegin[item.id]) || 0;
    const endVal = parseFloat(state.onHand[ik] ?? '') || 0;
    const hasBeg = state.trimarkBegin[item.id] !== undefined;
    const hasEnd = (state.onHand[ik] ?? '') !== '';
    if (hasBeg && hasEnd) {
      const usage = begVal - endVal;
      if (usage > 0) {
        totalUsage += usage;
        const cost = (item.unitCost || 0) * usage;
        totalBrkgCost += cost;
      }
    }
    const parVal = parseFloat(item.par) || 0;
    if (hasEnd && endVal < parVal) needsOrder++;
  });
  return { totalUsage, totalBrkgCost, needsOrder };
}

function showTrimarkHelp() {
  const existing = document.getElementById('trimark-help-sheet');
  if (existing) { existing.remove(); return; }

  const overlay = document.createElement('div');
  overlay.id = 'trimark-help-sheet';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9000;display:flex;align-items:flex-end;';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

  overlay.innerHTML = `
    <div style="background:#111;border-radius:24px 24px 0 0;width:100%;max-height:80vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:20px 20px calc(20px + env(safe-area-inset-bottom));">
      <div style="width:36px;height:4px;background:#3a3a3c;border-radius:2px;margin:0 auto 20px;"></div>
      <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:15px;font-weight:700;color:#c084fc;letter-spacing:1px;margin-bottom:16px;">üìã TRIMARK INVENTORY ‚Äî QUICK GUIDE</div>

      ${[
        ['üü£ STEP 1', 'Open Inventory Mode', 'Tap the purple üìã INVENTORY COUNT button at the top of the Trimark tab.'],
        ['üü£ STEP 2', 'Check BEGIN numbers', 'BEGIN = last month\'s ending count. Should already be filled in purple. If empty, enter manually.'],
        ['üü£ STEP 3', 'Count each item', 'Tap the purple TAP / COUNT cell. A window opens for 3 locations:\nüö¢ Dock  üö™ Closet  üçΩÔ∏è Restaurant\nType numbers separated by spaces e.g.  8  2  4  and the app adds them up.'],
        ['üü£ STEP 4', 'Read the results', 'USED = how many were lost or broken this month.\nLOSS $ = dollar value of what was lost.\nORDER = how many to order to get back to par.'],
        ['üü£ STEP 5', 'Place the order', 'Tap üìã INVENTORY COUNT again to go back to ORDER view. Review yellow order quantities. Tap üíæ SAVE.'],
        ['üü£ STEP 6', 'Email James', 'After saving, tap the purple üìß Email James? prompt at the bottom. Your email app will open with everything pre-filled. Just tap SEND. ‚úÖ'],
      ].map(([step, title, body]) => `
        <div style="margin-bottom:16px;padding:14px;background:#1c1c1e;border-radius:12px;border-left:3px solid #7c3aed;">
          <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#7c3aed;font-weight:700;letter-spacing:1px;margin-bottom:4px;">${step}</div>
          <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;color:#e5e5e7;margin-bottom:6px;">${title}</div>
          <div style="font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif;font-size:13px;color:#a3a3a3;line-height:1.6;white-space:pre-line;">${body}</div>
        </div>`).join('')}

      <div style="background:#2e1065;border:1.5px solid #7c3aed;border-radius:12px;padding:14px;margin-bottom:16px;">
        <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;color:#c084fc;margin-bottom:6px;">‚ö†Ô∏è IMPORTANT REMINDERS</div>
        <div style="font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif;font-size:13px;color:#e5e5e7;line-height:1.8;">
          ‚Ä¢ Count EVERY item ‚Äî even if you think it's fine<br>
          ‚Ä¢ If a count looks wrong (like 0 rocks glasses) double-check before saving<br>
          ‚Ä¢ After saving, tonight's COUNT becomes next month's BEGIN automatically<br>
          ‚Ä¢ If you made a mistake after saving, check History and note the correction
        </div>
      </div>

      <button onclick="document.getElementById('trimark-help-sheet').remove()" style="
        width:100%;height:50px;border-radius:14px;border:none;
        background:#7c3aed;color:#fff;font-family:ui-monospace,'SF Mono','Courier New',monospace;
        font-size:14px;font-weight:700;cursor:pointer;letter-spacing:0.5px;">
        GOT IT ‚úì
      </button>
    </div>`;

  document.body.appendChild(overlay);
}


  const summary = getTrimarkSummary(sup);

  // Header
  const hdr = document.createElement('div');
  hdr.style.cssText = 'padding:14px 16px 10px;background:#1c1c1e;border-bottom:1px solid #2c2c2e;';
  hdr.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
      <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:12px;font-weight:700;color:#c084fc;letter-spacing:1px;">üìã MONTHLY INVENTORY COUNT</div>
      <button onclick="showTrimarkHelp()" style="
        background:#2e1065;border:1.5px solid #7c3aed;border-radius:20px;
        color:#c084fc;font-family:ui-monospace,'SF Mono','Courier New',monospace;
        font-size:10px;font-weight:700;padding:4px 10px;cursor:pointer;
        letter-spacing:0.5px;">‚ùì HOW TO</button>
    </div>
    <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#636366;line-height:1.5">
      Tap any COUNT cell to enter by location. Tap ‚ùì HOW TO if you need help.
    </div>`;
  listEl.appendChild(hdr);

  // Hints zone ‚Äî shows contextual tips
  const hintsZone = document.createElement('div');
  hintsZone.id = 'tri-hints-zone';

  // Check for hint conditions
  const hints = [];
  const missingBegin = sup.items.filter(it => {
    const b = state.trimarkBegin[it.id];
    return b === undefined || b === '';
  });
  const missingCount = sup.items.filter(it => {
    const ik = ikey('TRIMARK', it.id);
    const e = state.onHand[ik] ?? '';
    return e === '';
  });
  const suspiciousZero = sup.items.filter(it => {
    const ik = ikey('TRIMARK', it.id);
    const e = parseFloat(state.onHand[ik]);
    return !isNaN(e) && e === 0 && parseFloat(it.par) > 10;
  });

  if (missingBegin.length > 0) hints.push({
    icon: '‚ö†Ô∏è', color: '#7c2d12', border: '#f97316',
    title: `${missingBegin.length} item${missingBegin.length>1?'s are':' is'} missing BEGIN numbers`,
    body: 'BEGIN should be last month\'s ending count. If this is your first time, enter the current count in both BEGIN and COUNT for those items.'
  });
  if (missingCount.length > 0) hints.push({
    icon: 'üü°', color: '#1c1a09', border: '#fbbf24',
    title: `${missingCount.length} item${missingCount.length>1?'s haven\'t':' hasn\'t'} been counted yet`,
    body: 'Tap the COUNT cell (purple TAP button) for each item as you walk through the restaurant.'
  });
  if (suspiciousZero.length > 0) hints.push({
    icon: 'üî¥', color: '#450a0a', border: '#f87171',
    title: `${suspiciousZero.length} item${suspiciousZero.length>1?'s show':' shows'} a count of 0`,
    body: 'Double-check: ' + suspiciousZero.slice(0,3).map(i=>i.name).join(', ') + (suspiciousZero.length>3?'‚Ä¶':'') + '. If correct, these will be marked critical and added to the order.'
  });

  if (hints.length > 0) {
    hintsZone.style.cssText = 'padding:8px 12px;display:flex;flex-direction:column;gap:6px;background:#0a0a0a;border-bottom:1px solid #1c1c1e;';
    hints.forEach(h => {
      const hintEl = document.createElement('div');
      hintEl.style.cssText = `background:${h.color};border:1.5px solid ${h.border};border-radius:10px;padding:10px 12px;`;
      hintEl.innerHTML = `
        <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;color:#f2f2f7;margin-bottom:3px;">${h.icon} ${h.title}</div>
        <div style="font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif;font-size:12px;color:rgba(255,255,255,0.6);line-height:1.5;">${h.body}</div>`;
      hintsZone.appendChild(hintEl);
    });
  } else if (missingCount.length === 0) {
    // All counted ‚Äî show a green all-clear
    hintsZone.style.cssText = 'padding:8px 12px;background:#0a0a0a;border-bottom:1px solid #1c1c1e;';
    hintsZone.innerHTML = `<div style="background:#052e16;border:1.5px solid #16a34a;border-radius:10px;padding:10px 12px;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;color:#4ade80;">‚úÖ All items counted ‚Äî review the ORDER column, then tap üíæ SAVE when ready.</div>`;
  }
  listEl.appendChild(hintsZone);

  // Summary bar
  const summaryBar = document.createElement('div');
  summaryBar.id = 'tri-summary-bar';
  summaryBar.style.cssText = 'padding:10px 16px;background:#2c1654;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;border-bottom:1px solid #3b0764;';
  summaryBar.innerHTML = buildTriSummaryHTML(summary);
  listEl.appendChild(summaryBar);

  // Column header
  const colHdr = document.createElement('div');
  colHdr.style.cssText = 'padding:6px 16px;background:#111;display:grid;grid-template-columns:1fr 64px 64px 64px 64px;gap:6px;align-items:center;border-bottom:1px solid #222;';
  colHdr.innerHTML = `
    <span style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px;color:#636366;letter-spacing:1px;">ITEM</span>
    <span style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px;color:#636366;letter-spacing:1px;text-align:center;">BEGIN</span>
    <span style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px;color:#c084fc;letter-spacing:1px;text-align:center;">COUNT</span>
    <span style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px;color:#f87171;letter-spacing:1px;text-align:center;">USED</span>
    <span style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px;color:#fbbf24;letter-spacing:1px;text-align:center;">ORDER</span>`;
  listEl.appendChild(colHdr);

  // Items
  sup.items.forEach((item, idx) => {
    const ik = ikey('TRIMARK', item.id);
    const begRaw = state.trimarkBegin[item.id];
    const endRaw = state.onHand[ik] ?? '';
    const begVal = parseFloat(begRaw);
    const endVal = parseFloat(endRaw);
    const hasBeg = begRaw !== undefined && begRaw !== '';
    const hasEnd = endRaw !== '';
    const usage = (hasBeg && hasEnd && !isNaN(begVal) && !isNaN(endVal)) ? begVal - endVal : null;
    const usagePos = usage !== null ? Math.max(0, usage) : null;
    const brkgCost = usagePos !== null ? usagePos * (item.unitCost || 0) : null;
    const parVal = parseFloat(item.par) || 0;
    const orderQty = hasEnd && !isNaN(endVal) ? Math.max(0, parVal - endVal) : null;
    const isLow = hasEnd && !isNaN(endVal) && endVal < parVal;
    const isCrit = hasEnd && !isNaN(endVal) && endVal <= 0;

    const row = document.createElement('div');
    row.style.cssText = `padding:10px 16px;border-bottom:1px solid #1c1c1e;display:grid;grid-template-columns:1fr 64px 64px 64px 64px;gap:6px;align-items:center;background:${isCrit ? 'rgba(248,113,113,0.09)' : isLow ? 'rgba(251,191,36,0.05)' : idx%2===0 ? '#0a0a0a' : 'transparent'};`;

    // Name col
    const nameDiv = document.createElement('div');
    nameDiv.innerHTML = `
      <div style="color:#e5e5e7;font-size:13px;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div>
      <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#48484a;margin-top:1px">par ${item.par}${item.unitCost ? ' ¬∑ $'+item.unitCost.toFixed(2) : ''}</div>
      ${brkgCost !== null && brkgCost > 0 ? `<div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#f87171;margin-top:1px">loss: $${brkgCost.toFixed(2)}</div>` : ''}`;

    // Begin input
    const begCol = document.createElement('div');
    begCol.style.cssText = 'display:flex;align-items:center;justify-content:center;';
    const begInp = document.createElement('input');
    begInp.type='number'; begInp.inputMode='decimal';
    begInp.value = hasBeg ? begRaw : '';
    begInp.placeholder = '‚Äî';
    begInp.style.cssText = `width:56px;height:38px;text-align:center;border-radius:8px;border:2px solid ${hasBeg ? '#7c3aed' : '#2c2c2e'};background:#1c1c1e;color:${hasBeg ? '#a78bfa' : '#636366'};font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:16px;font-weight:700;-webkit-appearance:none;appearance:none;outline:none;`;
    begInp.addEventListener('input', e => {
      const val = e.target.value;
      if (val !== '') { state.trimarkBegin[item.id] = val; }
      else { delete state.trimarkBegin[item.id]; }
      saveTrimarkBegin();
      begInp.style.borderColor = val !== '' ? '#7c3aed' : '#2c2c2e';
      begInp.style.color = val !== '' ? '#a78bfa' : '#636366';
      refreshTriRow(row, item, ik, listEl, sup);
    });
    begCol.appendChild(begInp);

    // Ending/count input ‚Äî taps open location tally modal
    const endCol = document.createElement('div');
    endCol.style.cssText = 'display:flex;align-items:center;justify-content:center;';

    // Show tally breakdown if locations saved
    const tally = state.trimarkTally[item.id];
    const hasTally = tally && (tally.dock || tally.closet || tally.restaurant);

    const endBtn = document.createElement('div');
    endBtn.style.cssText = `width:56px;min-height:38px;text-align:center;border-radius:8px;border:2px solid ${hasEnd ? '#c084fc' : '#2c2c2e'};background:#1c1c1e;color:${hasEnd ? '#c084fc' : '#636366'};font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:${hasEnd ? '16px' : '13px'};font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;padding:3px 2px;`;

    if (hasEnd) {
      endBtn.innerHTML = `<span style="font-size:16px;font-weight:700">${endRaw}</span>${hasTally ? `<span style="font-size:8px;color:#7c3aed;letter-spacing:0px;">${tally.dock||0}¬∑${tally.closet||0}¬∑${tally.restaurant||0}</span>` : ''}`;
    } else {
      endBtn.innerHTML = `<span style="font-size:13px;color:#48484a">TAP</span>`;
    }

    endBtn.addEventListener('click', () => {
      openTallyModal(item, (totalVal) => {
        // Update state
        state.onHand[ik] = totalVal;
        const pv = parseFloat(totalVal);
        if (!isNaN(pv)) {
          const suggested = Math.max(0, parVal - pv);
          state.orderQty[ik] = suggested > 0 ? String(Math.ceil(suggested)) : '';
          if (!state._autoFilled) state._autoFilled = {};
          state._autoFilled[ik] = true;
        } else {
          state.orderQty[ik] = '';
        }
        // Update button display
        const newTally = state.trimarkTally[item.id] || {};
        const nt = newTally;
        endBtn.style.borderColor = '#c084fc';
        endBtn.style.color = '#c084fc';
        endBtn.innerHTML = `<span style="font-size:16px;font-weight:700">${totalVal}</span><span style="font-size:8px;color:#7c3aed;letter-spacing:0px;">${nt.dock||0}¬∑${nt.closet||0}¬∑${nt.restaurant||0}</span>`;
        refreshTriRow(row, item, ik, listEl, sup);
      });
    });
    endCol.appendChild(endBtn);

    // Usage display
    const usageCol = document.createElement('div');
    usageCol.className = 'tri-usage-' + item.id;
    usageCol.style.cssText = 'text-align:center;font-family:ui-monospace,"SF Mono","Courier New",monospace;font-size:16px;font-weight:700;';
    usageCol.style.color = usagePos !== null && usagePos > 0 ? '#f87171' : '#48484a';
    usageCol.textContent = usagePos !== null ? (usagePos > 0 ? '-'+usagePos : '0') : '‚Äî';

    // Order qty display
    const orderCol = document.createElement('div');
    orderCol.className = 'tri-order-' + item.id;
    orderCol.style.cssText = 'text-align:center;font-family:ui-monospace,"SF Mono","Courier New",monospace;font-size:16px;font-weight:700;';
    orderCol.style.color = orderQty !== null && orderQty > 0 ? '#fbbf24' : '#48484a';
    orderCol.textContent = orderQty !== null ? (orderQty > 0 ? '+'+orderQty : '‚úì') : '‚Äî';

    row.appendChild(nameDiv);
    row.appendChild(begCol);
    row.appendChild(endCol);
    row.appendChild(usageCol);
    row.appendChild(orderCol);
    listEl.appendChild(row);
  });

  const spacer = document.createElement('div'); spacer.className = 'safe-bottom';
  listEl.appendChild(spacer);
}

function buildTriSummaryHTML(summary) {
  return `
    <span style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;color:#a78bfa;">
      üì¶ ${summary.needsOrder} need ordering
    </span>
    <span style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;color:#f87171;">
      üí∏ loss: $${summary.totalBrkgCost.toFixed(2)}
    </span>
    <button onclick="clearTrimarkInventory()" style="
      padding:4px 12px;border-radius:12px;border:1px solid #636366;
      background:transparent;color:#636366;
      font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;font-weight:700;
      cursor:pointer;">‚Ü∫ RESET MONTH</button>`;
}

function refreshTriRow(row, item, ik, listEl, sup) {
  // Recalculate and re-render the usage, order cols, and name subline
  const begRaw = state.trimarkBegin[item.id];
  const endRaw = state.onHand[ik] ?? '';
  const begVal = parseFloat(begRaw);
  const endVal = parseFloat(endRaw);
  const hasBeg = begRaw !== undefined && begRaw !== '';
  const hasEnd = endRaw !== '';
  const usage = (hasBeg && hasEnd && !isNaN(begVal) && !isNaN(endVal)) ? begVal - endVal : null;
  const usagePos = usage !== null ? Math.max(0, usage) : null;
  const brkgCost = usagePos !== null ? usagePos * (item.unitCost || 0) : null;
  const parVal = parseFloat(item.par) || 0;
  const orderQty = hasEnd && !isNaN(endVal) ? Math.max(0, parVal - endVal) : null;

  const usageEl = listEl.querySelector('.tri-usage-' + item.id);
  if (usageEl) {
    usageEl.textContent = usagePos !== null ? (usagePos > 0 ? '-'+usagePos : '0') : '‚Äî';
    usageEl.style.color = usagePos !== null && usagePos > 0 ? '#f87171' : '#48484a';
  }
  const orderEl = listEl.querySelector('.tri-order-' + item.id);
  if (orderEl) {
    orderEl.textContent = orderQty !== null ? (orderQty > 0 ? '+'+orderQty : '‚úì') : '‚Äî';
    orderEl.style.color = orderQty !== null && orderQty > 0 ? '#fbbf24' : '#48484a';
  }
  // Update summary bar
  const summary = getTrimarkSummary(sup);
  const bar = document.getElementById('tri-summary-bar');
  if (bar) bar.innerHTML = buildTriSummaryHTML(summary);
}

function clearTrimarkInventory() {
  if (!confirm('Reset this month\'s inventory counts? This will clear all BEGIN counts and location tallies. Ending counts (on-hand) will be kept.')) return;
  state.trimarkBegin = {};
  state.trimarkTally = {};
  saveTrimarkBegin();
  saveTrimarkTally();
  showToast('Month reset ‚Äî enter new beginning counts', 'warn');
  renderOrderView();
}

function clearAllBreakage() {
  state.breakage = {};
  saveBreakage();
  showToast('Breakage cleared', 'warn');
  renderOrderView();
}

// ‚îÄ‚îÄ‚îÄ HISTORY VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHistoryView() {
  document.getElementById('view-order').style.display = 'none';
  document.getElementById('view-history').style.display = 'flex';
  document.getElementById('view-mustknow').style.display = 'none';
  document.getElementById('hist-detail').classList.remove('show');

  if (state.selectedRec) {
    renderDetail(state.selectedRec);
    return;
  }

  // Filter chips
  const chipsEl = document.getElementById('filter-chips');
  chipsEl.innerHTML = '';
  ['ALL', ...SUP_NAMES].forEach(sn => {
    const btn = document.createElement('button');
    btn.className = 'chip' + (state.filterSup === sn ? ' active' : '');
    btn.textContent = sn === 'ALL' ? 'All' : sn;
    btn.onclick = () => { state.filterSup = sn; renderHistoryView(); };
    chipsEl.appendChild(btn);
  });

  const listEl = document.getElementById('history-list');
  listEl.innerHTML = '';

  const filtered = state.history.filter(r => state.filterSup === 'ALL' || r.suppliers?.[state.filterSup]);

  if (!filtered.length) {
    listEl.innerHTML = `<div class="empty-state"><div class="empty-icon">üïê</div><div class="empty-text">No orders saved yet.</div></div>`;
    return;
  }

  // Group by month
  const months = new Map();
  filtered.forEach(rec => {
    const d = new Date(rec.date);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const label = d.toLocaleDateString('en-US', {month:'long', year:'numeric'});
    if (!months.has(key)) months.set(key, {label, key, records:[]});
    months.get(key).records.push(rec);
  });

  months.forEach(({label, key, records}) => {
    // Month header
    const monthHdr = document.createElement('div');
    monthHdr.style.cssText = 'padding:10px 16px 6px;display:flex;align-items:center;justify-content:space-between;background:#000;position:sticky;top:0;z-index:10;border-bottom:1px solid #1c1c1e;';

    // Compute month totals
    const allMonthItems = records.flatMap(r => Object.values(r.suppliers||{}).flat());
    const monthOrders = allMonthItems.filter(i => i.orderQty && i.orderQty !== '' && i.orderQty !== '0').length;
    const monthCrit = allMonthItems.filter(i => i.status === 'critical').length;

    monthHdr.innerHTML = `
      <div>
        <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;color:#f2f2f7;">${label}</div>
        <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#48484a;margin-top:1px;">${records.length} order${records.length>1?'s':''} ¬∑ ${monthOrders} items${monthCrit>0?' ¬∑ üî¥ '+monthCrit:''}</div>
      </div>
      <button onclick="openMonthReport('${key}')" style="
        padding:5px 12px;border-radius:12px;border:1.5px solid #3a3a3c;
        background:transparent;color:#a3a3a3;
        font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;font-weight:700;
        cursor:pointer;letter-spacing:0.5px;">üìä REPORT</button>`;
    listEl.appendChild(monthHdr);

    // Records within this month
    records.forEach(rec => {
      const d = new Date(rec.date);
      const sups = Object.keys(rec.suppliers || {});
      const allItems = sups.flatMap(s => rec.suppliers[s]);
      const critCnt = allItems.filter(i => i.status === 'critical').length;
      const lowCnt  = allItems.filter(i => i.status === 'low').length;
      const ordCnt  = allItems.filter(i => i.orderQty && i.orderQty !== '').length;
      const hasNote = !!rec.globalNote || allItems.some(i => i.note);

      const row = document.createElement('div');
      row.className = 'hist-row';

      const mainBtn = document.createElement('button');
      mainBtn.className = 'hist-row-btn';
      mainBtn.onclick = () => { state.selectedRec = rec; renderDetail(rec); };

      const dateTile = `<div class="hist-date-tile">
        <span style="color:#ef4444;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px;font-weight:700">${d.toLocaleDateString('en-US',{month:'short'}).toUpperCase()}</span>
        <span style="color:#f2f2f7;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:22px;font-weight:800;line-height:1">${d.getDate()}</span>
        <span style="color:#636366;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px">${d.toLocaleDateString('en-US',{weekday:'short'}).toUpperCase()}</span>
      </div>`;

      const badges = sups.slice(0,4).map(sn => `<span class="sup-badge" style="background:${state.catalog[sn]?.color||'#333'}">${sn.split(' ')[0]}</span>`).join('') +
        (sups.length > 4 ? `<span style="color:#48484a;font-size:10px">+${sups.length-4}</span>` : '');

      const stats = [
        ordCnt  > 0 ? `<span style="color:#f97316;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px">üì¶ ${ordCnt}</span>` : '',
        critCnt > 0 ? `<span style="color:#f87171;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px">üî¥ ${critCnt}</span>` : '',
        lowCnt  > 0 ? `<span style="color:#fbbf24;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px">üü° ${lowCnt}</span>` : '',
        hasNote     ? `<span style="color:#d4a000;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px">‚úé</span>` : '',
      ].filter(Boolean).join('');

      mainBtn.innerHTML = `${dateTile}
        <div style="flex:1;min-width:0">
          <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:5px">${badges}</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">${stats}</div>
          <div style="color:#3a3a3c;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;margin-top:3px">
            ${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}
          </div>
        </div>
        <span style="color:#3a3a3c;font-size:22px">‚Ä∫</span>`;

      const printBtn = document.createElement('button');
      printBtn.className = 'hist-print-btn';
      printBtn.innerHTML = '<span>üñ®</span><span class="hist-print-label">PRINT</span>';
      printBtn.onclick = (e) => { e.stopPropagation(); openPrint(rec); };

      row.appendChild(mainBtn);
      row.appendChild(printBtn);
      listEl.appendChild(row);
    });
  });

  const spacer = document.createElement('div'); spacer.className = 'safe-bottom';
  listEl.appendChild(spacer);
}

function renderDetail(rec) {
  const detail = document.getElementById('hist-detail');
  detail.classList.add('show');

  const d = new Date(rec.date);
  const allItems = Object.values(rec.suppliers || {}).flat();
  const ordCnt = allItems.filter(i => i.orderQty && i.orderQty !== '').length;

  document.getElementById('detail-date').textContent =
    d.toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric', year:'numeric'});
  document.getElementById('detail-meta').textContent =
    d.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}) + ' ¬∑ ' + ordCnt + ' items ordered';

  const printBtn = document.getElementById('btn-print-detail');
  printBtn.onclick = () => openPrint(rec);

  const scroll = document.getElementById('detail-scroll');
  scroll.innerHTML = '';

  // ‚îÄ‚îÄ DELIVERY CONFIRMATION BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const CONFIRM_SUPS = ['ABCO', 'BEK', 'TRIMARK'];
  const hasConfirmableSups = Object.keys(rec.suppliers || {}).some(s => CONFIRM_SUPS.includes(s));

  if (hasConfirmableSups) {
    const delivBanner = document.createElement('div');
    delivBanner.style.cssText = 'margin:12px 16px 0;';

    if (rec.deliveryConfirmed) {
      // Show confirmation summary
      const missing = (rec.missingItems || []);
      if (missing.length > 0) {
        delivBanner.innerHTML = `
          <div style="background:#450a0a;border:1.5px solid #f87171;border-radius:14px;padding:12px 14px;margin-bottom:8px;">
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;font-weight:700;color:#f87171;letter-spacing:1px;margin-bottom:8px;">üî¥ ${missing.length} MISSING ITEM${missing.length>1?'S':''} ‚Äî FOLLOW UP WITH VENDOR</div>
            ${missing.map(m => `<div style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-top:1px solid rgba(248,113,113,0.2);">
              <div style="color:#fca5a5;font-size:13px;">${m.name}</div>
              <div style="color:#f87171;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;">ordered: ${m.orderQty}</div>
            </div>`).join('')}
            <button onclick="resolveShortage('${rec.id}')" style="margin-top:10px;width:100%;height:38px;border-radius:10px;background:transparent;border:1.5px solid #f87171;color:#f87171;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;cursor:pointer;letter-spacing:0.5px;">
              ‚úì MARK AS RESOLVED
            </button>
          </div>`;
      } else {
        delivBanner.innerHTML = `
          <div style="background:#052e16;border:1.5px solid #16a34a;border-radius:14px;padding:12px 14px;margin-bottom:8px;">
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;color:#4ade80;letter-spacing:1px;">‚úÖ DELIVERY CONFIRMED ‚Äî ALL ITEMS RECEIVED</div>
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#48484a;margin-top:4px;">Confirmed ${new Date(rec.confirmedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
          </div>`;
      }
    } else {
      delivBanner.innerHTML = `
        <button onclick="openDeliveryConfirmation('${rec.id}')" style="
          width:100%;height:48px;border-radius:14px;
          background:#0f172a;border:1.5px solid #3b82f6;
          color:#60a5fa;font-family:ui-monospace,'SF Mono','Courier New',monospace;
          font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.5px;
          display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px;">
          üì¶ CONFIRM DELIVERY ‚Äî CHECK ITEMS IN
        </button>`;
    }
    scroll.appendChild(delivBanner);
  }

  if (rec.globalNote) {
    const noteBox = document.createElement('div');
    noteBox.style.cssText = 'margin:12px 16px;background:#1c1c1e;border:1.5px solid #3a3a3c;border-radius:14px;padding:12px 14px';
    noteBox.innerHTML = `<div style="color:#fbbf24;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;letter-spacing:1px;margin-bottom:6px">üìù ORDER NOTE</div>
      <div style="color:#e5e5e7;font-family:-apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;font-size:15px;line-height:1.5">${rec.globalNote}</div>`;
    scroll.appendChild(noteBox);
  }

  Object.entries(rec.suppliers).forEach(([sn, items]) => {
    const s = state.catalog[sn] || DEFAULT_SUPPLIERS[sn];
    const block = document.createElement('div');

    const header = document.createElement('div');
    header.className = 'detail-sup-header';
    header.style.background = s?.color || '#333';
    header.innerHTML = `<span style="color:#fff;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:12px;font-weight:700">${sn}</span>
      <span style="color:rgba(255,255,255,0.45);font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px">${items.length} items</span>`;
    block.appendChild(header);

    items.forEach((item, idx) => {
      const itemEl = document.createElement('div');
      itemEl.className = 'detail-item' + (item.status === 'critical' ? ' critical' : item.status === 'low' ? ' low' : idx % 2 === 0 ? ' alt' : '');

      // Show received/missing status if delivery confirmed
      let confirmBadge = '';
      if (rec.deliveryConfirmed && item.orderQty && item.orderQty !== '') {
        const isMissing = (rec.missingItems || []).some(m => m.name === item.name);
        confirmBadge = isMissing
          ? `<span style="background:#dc2626;color:#fff;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;margin-left:6px;">MISSING</span>`
          : `<span style="background:#16a34a;color:#fff;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;margin-left:6px;">‚úì REC'D</span>`;
      }

      const row = document.createElement('div');
      row.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;gap:8px';
      row.innerHTML = `
        <div style="flex:1;min-width:0">
          <div style="color:#e5e5e7;font-family:-apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;font-size:14px;line-height:1.3">${item.name}${confirmBadge}</div>
          <div style="color:#48484a;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;margin-top:2px">${item.pack} ¬∑ par ${item.par}</div>
        </div>
        <div class="detail-values">
          <div class="detail-val-col">
            <div class="detail-val-label">ON HAND</div>
            <div class="detail-val">${item.onHand || '‚Äî'}</div>
          </div>
          ${item.begin ? `<div class="detail-val-col">
            <div class="detail-val-label">BEGIN</div>
            <div class="detail-val" style="color:#a78bfa">${item.begin}</div>
          </div>` : ''}
          ${item.usage ? `<div class="detail-val-col">
            <div class="detail-val-label">USED</div>
            <div class="detail-val" style="color:#f87171">-${item.usage}</div>
          </div>` : ''}
          ${item.brkgCost ? `<div class="detail-val-col">
            <div class="detail-val-label">LOSS</div>
            <div class="detail-val" style="color:#f87171;font-size:12px">$${item.brkgCost}</div>
          </div>` : ''}
          <div class="detail-val-col">
            <div class="detail-val-label">ORDERED</div>
            <div class="detail-val ${item.orderQty ? 'ordered' : 'empty'}">${item.orderQty || '‚Äî'}</div>
          </div>
          ${item.status ? `<span style="font-size:18px">${STATUS_ICONS[item.status]}</span>` : ''}
        </div>`;
      itemEl.appendChild(row);

      if (item.note) {
        const noteEl = document.createElement('div');
        noteEl.className = 'item-note-box';
        noteEl.textContent = '"' + item.note + '"';
        itemEl.appendChild(noteEl);
      }
      block.appendChild(itemEl);
    });

    scroll.appendChild(block);
  });

  const spacer = document.createElement('div'); spacer.className = 'safe-bottom';
  scroll.appendChild(spacer);
}

function closeDetail() {
  document.getElementById('hist-detail').classList.remove('show');
  state.selectedRec = null;
}

// ‚îÄ‚îÄ‚îÄ EDIT MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleEditMode() {
  state.editMode = !state.editMode;
  state.editingItem = null;
  render();
}

function startEdit(sn, item) {
  state.editingItem = {sn, id: item.id};
  document.getElementById('edit-sheet-sup').textContent = sn;
  document.getElementById('edit-name').value = item.name;
  document.getElementById('edit-pack').value = item.pack;
  document.getElementById('edit-par').value = item.par;
  document.getElementById('edit-sheet').style.display = 'flex';
  setTimeout(() => document.getElementById('edit-name').focus(), 100);
}

function cancelEdit() {
  state.editingItem = null;
  document.getElementById('edit-sheet').style.display = 'none';
}

function commitEdit() {
  if (!state.editingItem) return;
  const {sn, id} = state.editingItem;
  const name = document.getElementById('edit-name').value.trim();
  const pack = document.getElementById('edit-pack').value.trim();
  const par  = parseFloat(document.getElementById('edit-par').value);

  state.catalog[sn].items = state.catalog[sn].items.map(it =>
    it.id === id ? {...it, name: name||it.name, pack: pack||it.pack, par: isNaN(par) ? it.par : par} : it
  );
  saveCatalog();
  cancelEdit();
  showToast('‚úì Item updated');
  render();
}

// ‚îÄ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSaveModal() {
  // Reset delivery to "Tomorrow" default each time
  document.querySelectorAll('.del-chip').forEach(c => c.classList.remove('active'));
  document.querySelector('.del-chip[data-val="next"]').classList.add('active');
  document.getElementById('delivery-custom-date').style.display = 'none';
  document.getElementById('delivery-custom-date').value = '';
  updateDeliveryDisplay();
  document.getElementById('save-modal').style.display = 'flex';
}
function closeSaveModal() { document.getElementById('save-modal').style.display = 'none'; }

function selectDelivery(btn, val) {
  document.querySelectorAll('.del-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  const customInp = document.getElementById('delivery-custom-date');
  if (val === 'custom') {
    customInp.style.display = 'block';
    // Default to tomorrow
    const tmr = new Date(); tmr.setDate(tmr.getDate() + 1);
    if (!customInp.value) customInp.value = tmr.toISOString().split('T')[0];
    customInp.addEventListener('change', updateDeliveryDisplay);
    customInp.focus();
  } else {
    customInp.style.display = 'none';
  }
  updateDeliveryDisplay();
}

function getDeliveryDate() {
  const active = document.querySelector('.del-chip.active');
  const val = active?.dataset.val;
  const today = new Date();
  if (val === 'next')   { const d = new Date(today); d.setDate(d.getDate()+1); return d; }
  if (val === '2day')   { const d = new Date(today); d.setDate(d.getDate()+2); return d; }
  if (val === '3day')   { const d = new Date(today); d.setDate(d.getDate()+3); return d; }
  if (val === 'custom') {
    const raw = document.getElementById('delivery-custom-date').value;
    if (raw) return new Date(raw + 'T12:00:00');
  }
  const d = new Date(today); d.setDate(d.getDate()+1); return d;
}

function updateDeliveryDisplay() {
  const d = getDeliveryDate();
  const label = d.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'});
  document.getElementById('delivery-display').textContent = 'üìÖ ' + label;
}

function doSave() {
  const btn = document.getElementById('btn-confirm-save');
  btn.textContent = 'SAVING‚Ä¶'; btn.disabled = true;

  const deliveryDate = getDeliveryDate();
  const snap = { id: 'rec_' + Date.now(), date: new Date().toISOString(), deliveryDate: deliveryDate.toISOString(), globalNote: state.globalNote.trim(), suppliers: {} };
  for (const [sn, s] of Object.entries(state.catalog)) {
    const items = s.items.reduce((acc, it) => {
      const oh = state.onHand[ikey(sn, it.id)] ?? '';
      const oq = state.orderQty[ikey(sn, it.id)] ?? '';
      const nt = state.itemNotes[ikey(sn, it.id)] ?? '';
      const brk = sn === 'TRIMARK' ? (state.breakage[it.id] ?? '') : '';
      const beg = sn === 'TRIMARK' ? (state.trimarkBegin[it.id] ?? '') : '';
      const begV = parseFloat(beg), ohV = parseFloat(oh);
      const usageCalc = sn === 'TRIMARK' && beg !== '' && oh !== '' && !isNaN(begV) && !isNaN(ohV) ? String(Math.max(0, begV - ohV)) : '';
      if (oh !== '' || oq !== '' || nt !== '') {
        acc.push({name:it.name, pack:it.pack, par:it.par, onHand:oh, orderQty:oq, note:nt, status:getStatus(oh, it.par),
          ...(brk !== '' && brk !== '0' ? {breakage: brk} : {}),
          ...(beg !== '' ? {begin:beg} : {}),
          ...(usageCalc !== '' && usageCalc !== '0' ? {usage:usageCalc} : {}),
          ...(it.unitCost && usageCalc !== '' ? {brkgCost:(parseFloat(usageCalc)*it.unitCost).toFixed(2)} : {})});
      }
      return acc;
    }, []);
    if (items.length) snap.suppliers[sn] = items;
  }

  const hasData = Object.keys(snap.suppliers).length > 0 || snap.globalNote;
  if (!hasData) {
    showToast('Nothing entered yet.', 'warn');
    btn.textContent = '‚úì  CONFIRM SAVE & RESET'; btn.disabled = false;
    closeSaveModal(); return;
  }

  state.history = [snap, ...state.history].slice(0, 365);
  lsSet('bartletts-orders-v3', state.history);
  fbSaveRecord(snap); // sync to Firebase

  // Reset
  // For Trimark: carry ending counts forward as next month's beginning
  const triItems = state.catalog['TRIMARK']?.items || [];
  const newBegin = {};
  triItems.forEach(it => {
    const ik = ikey('TRIMARK', it.id);
    const endVal = state.onHand[ik];
    if (endVal !== undefined && endVal !== '') newBegin[it.id] = endVal;
  });
  state.trimarkBegin = newBegin;
  saveTrimarkBegin();
  state.trimarkTally = {};
  saveTrimarkTally();

  state.onHand = {}; state.orderQty = {};
  state.itemNotes = {}; state.globalNote = ''; state._openNote = null;
  state.breakage = {}; saveBreakage();
  state.trimarkView = 'order';

  btn.textContent = '‚úì  CONFIRM SAVE & RESET'; btn.disabled = false;
  closeSaveModal();

  showToast('‚úì Saved & reset!');
  render();

  // ‚îÄ‚îÄ LEARNING ENGINE ‚Äî record this order silently ‚îÄ‚îÄ
  recordOrderLearning(snap);

  // If ABCO had items ordered, show SMS prompt
  const abcoItems = snap.suppliers['ABCO'] || [];
  const abcoOrdered = abcoItems.filter(i => i.orderQty && i.orderQty !== '' && i.orderQty !== '0');
  if (abcoOrdered.length > 0) {
    setTimeout(() => showAbcoSmsPrompt(abcoOrdered), 600);
  }

  // If TRIMARK had items ordered, show email prompt
  const triItems = snap.suppliers['TRIMARK'] || [];
  const triOrdered = triItems.filter(i => i.orderQty && i.orderQty !== '' && i.orderQty !== '0');
  if (triOrdered.length > 0) {
    setTimeout(() => showTrimarkEmailPrompt(triOrdered), abcoOrdered.length > 0 ? 1400 : 600);
  }

  // If ELECTRICAL had items ordered, show email prompt
  const elcItems = snap.suppliers['ELECTRICAL'] || [];
  const elcOrdered = elcItems.filter(i => i.orderQty && i.orderQty !== '' && i.orderQty !== '0');
  if (elcOrdered.length > 0) {
    const delay = 600 + (abcoOrdered.length > 0 ? 800 : 0) + (triOrdered.length > 0 ? 800 : 0);
    setTimeout(() => showElectricalEmailPrompt(elcOrdered), delay);
  }
}

function showAbcoSmsPrompt(items) {
  const existing = document.getElementById('abco-sms-prompt');
  if (existing) existing.remove();

  const el = document.createElement('div');
  el.id = 'abco-sms-prompt';
  el.style.cssText = `
    position:fixed;bottom:calc(72px + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%);
    background:#1c1c1e;border:1.5px solid #3a3a3c;border-radius:16px;
    padding:14px 18px;display:flex;align-items:center;gap:12px;
    box-shadow:0 8px 32px rgba(0,0,0,0.6);z-index:9999;
    font-family:ui-monospace,'SF Mono','Courier New',monospace;
    max-width:calc(100vw - 32px);
  `;
  el.innerHTML = `
    <div style="font-size:11px;color:#a3a3a3;line-height:1.4;">
      <div style="color:#e5e5e7;font-weight:700;font-size:12px;margin-bottom:2px;">üì± Text Hal?</div>
      ${items.length} item${items.length > 1 ? 's' : ''} to order from ABCO
    </div>
    <button onclick="openAbcoSms()" style="
      flex-shrink:0;height:38px;padding:0 16px;border-radius:19px;
      background:#ef4444;border:none;color:#fff;
      font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;
      cursor:pointer;letter-spacing:0.5px;">
      OPEN SMS
    </button>
    <button onclick="document.getElementById('abco-sms-prompt').remove()" style="
      flex-shrink:0;width:28px;height:28px;border-radius:14px;
      background:#2c2c2e;border:none;color:#636366;font-size:16px;
      cursor:pointer;display:flex;align-items:center;justify-content:center;">√ó</button>
  `;
  document.body.appendChild(el);

  // Store items for when button is pressed
  el._items = items;

  // Auto-dismiss after 12 seconds
  setTimeout(() => { if (el.parentNode) el.remove(); }, 12000);
}

function openAbcoSms() {
  const el = document.getElementById('abco-sms-prompt');
  const items = el?._items || [];
  el?.remove();

  // Format each item as "-x{qty} {name}", grouped in rows of 3
  const formatted = items.map(i => `-x${i.orderQty} ${i.name}`);
  const rows = [];
  for (let i = 0; i < formatted.length; i += 3) {
    rows.push(formatted.slice(i, i + 3).join('   '));
  }
  const body = `Hi Hal, ABCO order:\n\n${rows.join('\n')}\n\nThanks`;
  const encoded = encodeURIComponent(body);
  window.location.href = `sms:5128015422&body=${encoded}`;
}

function showTrimarkEmailPrompt(items) {
  const existing = document.getElementById('trimark-email-prompt');
  if (existing) existing.remove();

  const el = document.createElement('div');
  el.id = 'trimark-email-prompt';
  el.style.cssText = `
    position:fixed;bottom:calc(72px + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%);
    background:#1c1c1e;border:1.5px solid #7c3aed;border-radius:16px;
    padding:14px 18px;display:flex;align-items:center;gap:12px;
    box-shadow:0 8px 32px rgba(0,0,0,0.6);z-index:9999;
    font-family:ui-monospace,'SF Mono','Courier New',monospace;
    max-width:calc(100vw - 32px);
  `;
  el.innerHTML = `
    <div style="font-size:11px;color:#a3a3a3;line-height:1.4;">
      <div style="color:#e5e5e7;font-weight:700;font-size:12px;margin-bottom:2px;">üìß Email James?</div>
      ${items.length} item${items.length > 1 ? 's' : ''} to order from Trimark
    </div>
    <button onclick="openTrimarkEmail()" style="
      flex-shrink:0;height:38px;padding:0 16px;border-radius:19px;
      background:#7c3aed;border:none;color:#fff;
      font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;
      cursor:pointer;letter-spacing:0.5px;">
      OPEN EMAIL
    </button>
    <button onclick="document.getElementById('trimark-email-prompt').remove()" style="
      flex-shrink:0;width:28px;height:28px;border-radius:14px;
      background:#2c2c2e;border:none;color:#636366;font-size:16px;
      cursor:pointer;display:flex;align-items:center;justify-content:center;">√ó</button>
  `;
  document.body.appendChild(el);
  el._items = items;
  setTimeout(() => { if (el.parentNode) el.remove(); }, 12000);
}

function openTrimarkEmail() {
  const el = document.getElementById('trimark-email-prompt');
  const items = el?._items || [];
  el?.remove();

  const date = new Date().toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
  const lines = items.map(i => `  - x${i.orderQty}  ${i.name}`).join('\n');
  const subject = `Bartlett's Trimark Order ‚Äî ${date}`;
  const body = `Hi James,\n\nPlease process the following order for Bartlett's Restaurant:\n\n${lines}\n\nThank you,\nOscar Rivas\nBartlett's Restaurant`;

  const mailto = `mailto:James.Hawley@trimarkusa.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailto;
}

// ‚îÄ‚îÄ‚îÄ DELIVERY CONFIRMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDeliveryConfirmation(recId) {
  const rec = state.history.find(r => r.id === recId);
  if (!rec) return;

  const CONFIRM_SUPS = ['ABCO', 'BEK', 'TRIMARK'];
  const orderedItems = [];
  Object.entries(rec.suppliers || {}).forEach(([sn, items]) => {
    if (!CONFIRM_SUPS.includes(sn)) return;
    items.forEach(it => {
      if (it.orderQty && it.orderQty !== '' && it.orderQty !== '0') {
        orderedItems.push({...it, supplier: sn});
      }
    });
  });

  if (!orderedItems.length) { showToast('No ordered items to confirm'); return; }

  const existing = document.getElementById('delivery-confirm-modal');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'delivery-confirm-modal';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9500;display:flex;align-items:flex-end;';

  // Track checked state
  const checked = {};
  orderedItems.forEach(it => { checked[it.supplier+'|'+it.name] = true; }); // default all received

  function buildContent() {
    const supColors = {ABCO:'#1e4d35',BEK:'#0f172a',TRIMARK:'#3b0764'};
    const rows = orderedItems.map(it => {
      const k = it.supplier+'|'+it.name;
      const isChecked = checked[k];
      return `<div style="display:flex;align-items:center;gap:12px;padding:11px 16px;border-bottom:1px solid #1c1c1e;background:${isChecked?'transparent':'rgba(220,38,38,0.08)'};">
        <div onclick="toggleDeliveryCheck('${k}')" style="
          width:26px;height:26px;border-radius:8px;flex-shrink:0;cursor:pointer;
          background:${isChecked?'#16a34a':'transparent'};
          border:2px solid ${isChecked?'#16a34a':'#3a3a3c'};
          display:flex;align-items:center;justify-content:center;
          font-size:14px;color:#fff;">
          ${isChecked?'‚úì':''}
        </div>
        <div style="flex:1;min-width:0;">
          <div style="color:${isChecked?'#e5e5e7':'#636366'};font-size:14px;${isChecked?'':'text-decoration:line-through;'}">${it.name}</div>
          <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#48484a;margin-top:1px;">
            <span style="background:${supColors[it.supplier]||'#333'};color:#fff;padding:1px 6px;border-radius:6px;font-size:9px;margin-right:6px;">${it.supplier}</span>
            ordered: ${it.orderQty}
          </div>
        </div>
      </div>`;
    }).join('');

    const uncheckedCount = orderedItems.filter(it => !checked[it.supplier+'|'+it.name]).length;

    overlay.innerHTML = `
      <div style="background:#111;border-radius:24px 24px 0 0;width:100%;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;">
        <div style="padding:16px 20px;border-bottom:1px solid #1c1c1e;flex-shrink:0;">
          <div style="width:36px;height:4px;background:#3a3a3c;border-radius:2px;margin:0 auto 14px;"></div>
          <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;color:#60a5fa;letter-spacing:1px;margin-bottom:4px;">üì¶ CONFIRM DELIVERY</div>
          <div style="font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif;font-size:13px;color:#636366;">
            Check off each item as it arrives. Uncheck anything missing.
          </div>
        </div>
        <div style="overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch;" id="delivery-confirm-list">
          <div style="padding:6px 16px;background:#0a0a0a;display:flex;justify-content:space-between;align-items:center;">
            <button onclick="toggleAllDelivery(true)" style="background:transparent;border:none;color:#4ade80;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;cursor:pointer;padding:6px 0;">‚úì ALL RECEIVED</button>
            <button onclick="toggleAllDelivery(false)" style="background:transparent;border:none;color:#f87171;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;cursor:pointer;padding:6px 0;">‚úó CLEAR ALL</button>
          </div>
          ${rows}
        </div>
        <div style="padding:16px 20px;border-top:1px solid #1c1c1e;flex-shrink:0;padding-bottom:max(16px,env(safe-area-inset-bottom));">
          ${uncheckedCount > 0 ? `<div style="background:#450a0a;border:1px solid #f87171;border-radius:10px;padding:8px 12px;margin-bottom:12px;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;color:#f87171;font-weight:700;">
            ‚ö†Ô∏è ${uncheckedCount} item${uncheckedCount>1?'s are':' is'} unchecked ‚Äî will be flagged as MISSING
          </div>` : ''}
          <div style="display:flex;gap:10px;">
            <button onclick="document.getElementById('delivery-confirm-modal').remove()" style="flex:1;height:48px;border-radius:14px;background:transparent;border:1.5px solid #3a3a3c;color:#636366;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;cursor:pointer;">Cancel</button>
            <button onclick="saveDeliveryConfirmation('${recId}')" style="flex:2;height:48px;border-radius:14px;background:#16a34a;border:none;color:#fff;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;cursor:pointer;letter-spacing:0.5px;">‚úì CONFIRM DELIVERY</button>
          </div>
        </div>
      </div>`;
  }

  window._deliveryChecked = checked;
  window._deliveryItems = orderedItems;
  buildContent();
  document.body.appendChild(overlay);

  window.toggleDeliveryCheck = (k) => {
    window._deliveryChecked[k] = !window._deliveryChecked[k];
    buildContent();
  };
  window.toggleAllDelivery = (val) => {
    orderedItems.forEach(it => { window._deliveryChecked[it.supplier+'|'+it.name] = val; });
    buildContent();
  };
}

function saveDeliveryConfirmation(recId) {
  const rec = state.history.find(r => r.id === recId);
  if (!rec) return;

  const missing = window._deliveryItems.filter(it => !window._deliveryChecked[it.supplier+'|'+it.name]);

  rec.deliveryConfirmed = true;
  rec.confirmedAt = new Date().toISOString();
  rec.missingItems = missing.map(it => ({name: it.name, orderQty: it.orderQty, supplier: it.supplier}));

  lsSet('bartletts-orders-v3', state.history);
  fbSaveRecord(rec);

  document.getElementById('delivery-confirm-modal')?.remove();

  if (missing.length > 0) {
    showToast(`‚ö†Ô∏è ${missing.length} missing item${missing.length>1?'s':''} flagged`);
    updateMissingBanner();
  } else {
    showToast('‚úÖ Delivery confirmed ‚Äî all items received');
  }

  renderDetail(rec);
}

function resolveShortage(recId) {
  const rec = state.history.find(r => r.id === recId);
  if (!rec) return;
  rec.missingItems = [];
  rec.shortageResolved = true;
  lsSet('bartletts-orders-v3', state.history);
  fbSaveRecord(rec);
  updateMissingBanner();
  renderDetail(rec);
  showToast('‚úÖ Shortage marked as resolved');
}

function updateMissingBanner() {
  const existing = document.getElementById('missing-banner');
  if (existing) existing.remove();

  const unresolved = state.history.filter(r =>
    r.deliveryConfirmed && r.missingItems && r.missingItems.length > 0 && !r.shortageResolved
  );

  if (!unresolved.length) return;

  const totalMissing = unresolved.reduce((sum, r) => sum + r.missingItems.length, 0);

  const banner = document.createElement('div');
  banner.id = 'missing-banner';
  banner.style.cssText = `
    position:fixed;top:calc(56px + env(safe-area-inset-top));left:0;right:0;
    background:#7f1d1d;border-bottom:2px solid #dc2626;
    padding:8px 16px;display:flex;align-items:center;justify-content:space-between;
    z-index:8000;font-family:ui-monospace,'SF Mono','Courier New',monospace;
    cursor:pointer;
  `;
  banner.innerHTML = `
    <div style="font-size:11px;font-weight:700;color:#fca5a5;letter-spacing:0.5px;">
      üî¥ ${totalMissing} MISSING ITEM${totalMissing>1?'S':''} ‚Äî TAP TO REVIEW
    </div>
    <div style="font-size:10px;color:#f87171;">${unresolved.length} order${unresolved.length>1?'s':''}</div>`;
  banner.onclick = () => {
    state.tab = 'history';
    state.selectedRec = unresolved[0];
    render();
    renderDetail(unresolved[0]);
  };
  document.getElementById('app').insertAdjacentElement('afterbegin', banner);
}

// ‚îÄ‚îÄ‚îÄ LEARNING ENGINE (Stage 1 ‚Äî Silent Data Collection) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function recordOrderLearning(snap) {
  try {
    const existing = lsGet('bartletts-learning-v1') || {};
    const dayOfWeek = new Date(snap.date).getDay(); // 0=Sun...6=Sat
    const month = new Date(snap.date).getMonth();

    Object.entries(snap.suppliers || {}).forEach(([sn, items]) => {
      items.forEach(it => {
        const qty = parseFloat(it.orderQty) || 0;
        if (qty <= 0) return;
        const k = sn + '|' + it.name;
        if (!existing[k]) existing[k] = { supplier: sn, name: it.name, orders: [] };
        existing[k].orders.push({ qty, dow: dayOfWeek, month, date: snap.date });
        // Keep last 52 entries per item (1 year of weekly data)
        if (existing[k].orders.length > 52) existing[k].orders = existing[k].orders.slice(-52);
      });
    });
    lsSet('bartletts-learning-v1', existing);
  } catch(e) { console.warn('Learning engine error:', e); }
}

// ‚îÄ‚îÄ‚îÄ ELECTRICAL EMAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showElectricalEmailPrompt(items) {
  const existing = document.getElementById('electrical-email-prompt');
  if (existing) existing.remove();

  const el = document.createElement('div');
  el.id = 'electrical-email-prompt';
  el.style.cssText = `
    position:fixed;bottom:calc(72px + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%);
    background:#1c1c1e;border:1.5px solid #f59e0b;border-radius:16px;
    padding:14px 18px;display:flex;align-items:center;gap:12px;
    box-shadow:0 8px 32px rgba(0,0,0,0.6);z-index:9999;
    font-family:ui-monospace,'SF Mono','Courier New',monospace;
    max-width:calc(100vw - 32px);
  `;
  el.innerHTML = `
    <div style="font-size:11px;color:#a3a3a3;line-height:1.4;">
      <div style="color:#e5e5e7;font-weight:700;font-size:12px;margin-bottom:2px;">üí° Email Electrical Vendor?</div>
      ${items.length} item${items.length>1?'s':''} to order
    </div>
    <button onclick="openElectricalEmail()" style="
      flex-shrink:0;height:38px;padding:0 16px;border-radius:19px;
      background:#f59e0b;border:none;color:#000;
      font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700;
      cursor:pointer;letter-spacing:0.5px;">
      OPEN EMAIL
    </button>
    <button onclick="document.getElementById('electrical-email-prompt').remove()" style="
      flex-shrink:0;width:28px;height:28px;border-radius:14px;
      background:#2c2c2e;border:none;color:#636366;font-size:16px;
      cursor:pointer;display:flex;align-items:center;justify-content:center;">√ó</button>
  `;
  document.body.appendChild(el);
  el._items = items;
  setTimeout(() => { if (el.parentNode) el.remove(); }, 12000);
}

function openElectricalEmail() {
  const el = document.getElementById('electrical-email-prompt');
  const items = el?._items || [];
  el?.remove();

  const sup = state.catalog['ELECTRICAL'] || DEFAULT_SUPPLIERS['ELECTRICAL'];
  const toEmail = sup.email || '';
  const vendorName = sup.vendorName || 'Vendor';
  const date = new Date().toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
  const lines = items.map(i => `  - x${i.orderQty}  ${i.name}${i.location?' ('+i.location+')':''}`).join('\n');
  const subject = `Bartlett's Electrical Order ‚Äî ${date}`;
  const body = `Hi ${vendorName},\n\nPlease process the following order for Bartlett's Restaurant:\n\n${lines}\n\nThank you,\nOscar Rivas\nBartlett's Restaurant`;

  const mailto = `mailto:${toEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailto;
}


function openMonthReport(monthKey) {
  const [year, month] = monthKey.split('-').map(Number);
  const records = state.history.filter(r => {
    const d = new Date(r.date);
    return d.getFullYear() === year && d.getMonth()+1 === month;
  });
  if (!records.length) return;

  const monthLabel = new Date(year, month-1, 1).toLocaleDateString('en-US', {month:'long', year:'numeric'});

  // Aggregate all items across all orders this month
  const itemTotals = {}; // "SUP|name" ‚Üí {name, pack, sup, totalOrdered, orderCount, critCount}
  records.forEach(rec => {
    Object.entries(rec.suppliers||{}).forEach(([sn, items]) => {
      items.forEach(it => {
        const k = sn + '|' + it.name;
        if (!itemTotals[k]) itemTotals[k] = {name:it.name, pack:it.pack||'', sup:sn, totalOrdered:0, orderCount:0, critCount:0, lowCount:0};
        const qty = parseFloat(it.orderQty) || 0;
        if (qty > 0) { itemTotals[k].totalOrdered += qty; itemTotals[k].orderCount++; }
        if (it.status === 'critical') itemTotals[k].critCount++;
        if (it.status === 'low') itemTotals[k].lowCount++;
      });
    });
  });

  // Group by supplier
  const bySup = {};
  Object.values(itemTotals).forEach(it => {
    if (!bySup[it.sup]) bySup[it.sup] = [];
    bySup[it.sup].push(it);
  });

  const totalOrders = records.length;
  const totalItemsOrdered = Object.values(itemTotals).filter(i => i.totalOrdered > 0).length;

  let supBlocks = Object.entries(bySup).map(([sn, items]) => {
    const sup = state.catalog[sn] || DEFAULT_SUPPLIERS[sn];
    const rows = items.sort((a,b) => b.totalOrdered - a.totalOrdered).map(it => `
      <tr style="border-bottom:2px solid #f3f4f6;">
        <td style="padding:14px 16px;font-size:17px;font-weight:500;">${it.name}</td>
        <td style="padding:14px 16px;font-size:15px;color:#6b7280;">${it.pack}</td>
        <td style="padding:14px 16px;text-align:center;font-weight:800;font-size:22px;color:${it.totalOrdered>0?'#111':'#9ca3af'}">${it.totalOrdered || '‚Äî'}</td>
        <td style="padding:14px 16px;text-align:center;font-size:16px;color:#6b7280;">${it.orderCount>0?it.orderCount+'x':'‚Äî'}</td>
        <td style="padding:14px 16px;text-align:center;font-size:17px;">${it.critCount>0?'üî¥ '+it.critCount:it.lowCount>0?'üü° '+it.lowCount:'‚Äî'}</td>
      </tr>`).join('');
    return `
      <div style="margin-bottom:36px;">
        <div style="background:${sup.color||'#1e293b'};color:#fff;padding:14px 20px;border-radius:10px 10px 0 0;font-family:monospace;font-size:17px;font-weight:700;letter-spacing:2px;">${sn}</div>
        <table style="width:100%;border-collapse:collapse;background:#fff;border-radius:0 0 10px 10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
          <thead><tr style="background:#f9fafb;border-bottom:3px solid #e5e7eb;">
            <th style="padding:12px 16px;text-align:left;font-size:13px;color:#6b7280;font-family:monospace;letter-spacing:1px;">ITEM</th>
            <th style="padding:12px 16px;text-align:left;font-size:13px;color:#6b7280;font-family:monospace;letter-spacing:1px;">PACK</th>
            <th style="padding:12px 16px;text-align:center;font-size:13px;color:#6b7280;font-family:monospace;letter-spacing:1px;">TOTAL QTY</th>
            <th style="padding:12px 16px;text-align:center;font-size:13px;color:#6b7280;font-family:monospace;letter-spacing:1px;">ORDERS</th>
            <th style="padding:12px 16px;text-align:center;font-size:13px;color:#6b7280;font-family:monospace;letter-spacing:1px;">ALERTS</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }).join('');

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Monthly Report ‚Äî ${monthLabel}</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f8fafc; color: #111; margin: 0; padding: 32px;
        font-size: 16px; line-height: 1.5;
      }
      @media print {
        body { padding: 16px; background: #fff; }
        button { display: none !important; }
      }
      @media (max-width: 600px) {
        body { padding: 16px; }
        table { font-size: 15px; }
      }
    </style>
  </head><body>

  <button onclick="window.print()" style="
    margin-bottom:28px;padding:14px 28px;background:#ef4444;color:#fff;
    border:none;border-radius:10px;font-weight:700;cursor:pointer;
    font-size:17px;letter-spacing:0.5px;">üñ® Print Report</button>

  <!-- Header -->
  <div style="border-bottom:4px solid #ef4444;padding-bottom:24px;margin-bottom:32px;">
    <div style="font-size:32px;font-weight:800;color:#ef4444;letter-spacing:3px;font-family:monospace;">BARTLETT'S</div>
    <div style="font-size:16px;color:#6b7280;letter-spacing:2px;font-family:monospace;margin-top:4px;">MONTHLY ORDER REPORT</div>
    <div style="font-size:28px;font-weight:700;margin-top:12px;">${monthLabel}</div>

    <!-- Summary tiles -->
    <div style="display:flex;gap:16px;margin-top:20px;flex-wrap:wrap;">
      <div style="background:#fff;border:2px solid #e5e7eb;border-radius:12px;padding:16px 24px;text-align:center;min-width:100px;">
        <div style="font-size:32px;font-weight:800;color:#111;font-family:monospace;">${totalOrders}</div>
        <div style="font-size:13px;color:#6b7280;font-family:monospace;margin-top:4px;">ORDERS PLACED</div>
      </div>
      <div style="background:#fff;border:2px solid #e5e7eb;border-radius:12px;padding:16px 24px;text-align:center;min-width:100px;">
        <div style="font-size:32px;font-weight:800;color:#f97316;font-family:monospace;">${totalItemsOrdered}</div>
        <div style="font-size:13px;color:#6b7280;font-family:monospace;margin-top:4px;">ITEMS ORDERED</div>
      </div>
      <div style="background:#fff;border:2px solid #e5e7eb;border-radius:12px;padding:16px 24px;text-align:center;min-width:100px;">
        <div style="font-size:32px;font-weight:800;color:#111;font-family:monospace;">${Object.keys(bySup).length}</div>
        <div style="font-size:13px;color:#6b7280;font-family:monospace;margin-top:4px;">SUPPLIERS</div>
      </div>
    </div>
  </div>

  ${supBlocks}

  <div style="margin-top:32px;padding-top:16px;border-top:2px solid #e5e7eb;display:flex;justify-content:space-between;font-size:13px;color:#9ca3af;font-family:monospace;flex-wrap:wrap;gap:8px;">
    <span>¬© 2025 Oscar Rivas ¬∑ Bartlett's Restaurant ¬∑ All rights reserved</span>
    <span>Generated: ${new Date().toLocaleString('en-US')}</span>
  </div>

  </body></html>`;

  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const w = window.open(url, '_blank');
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}


function openPrint(rec) {
  const d = new Date(rec.date);
  const dateStr = d.toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
  const timeStr = d.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});

  const deliveryStr = rec.deliveryDate
    ? new Date(rec.deliveryDate).toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'})
    : null;
  const allItems = Object.values(rec.suppliers||{}).flat();
  const orderedItems = allItems.filter(i => i.orderQty && i.orderQty !== '');
  const critItems = allItems.filter(i => i.status === 'critical');
  const lowItems  = allItems.filter(i => i.status === 'low');

  const supBlocks = Object.entries(rec.suppliers||{}).map(([sn, items]) => {
    const sup = state.catalog[sn]||DEFAULT_SUPPLIERS[sn];
    const ordered = items.filter(i => i.orderQty && i.orderQty !== '');
    if (!ordered.length) return '';
    const rows = ordered.map((item,idx) => {
      const sc = item.status==='critical'?'#dc2626':item.status==='low'?'#d97706':'#16a34a';
      const sl = item.status==='critical'?'‚ö† ASAP':item.status==='low'?'‚Üì Low':'‚úì OK';
      const bg = idx%2===0?'#f9fafb':'#fff';
      const begCell = sn==='TRIMARK' ? `<td style="padding:8px 10px;font-size:12px;color:#a78bfa;border-bottom:1px solid #e5e7eb;text-align:center">${item.begin||'‚Äî'}</td>` : '';
      const usedCell = sn==='TRIMARK' ? `<td style="padding:8px 10px;font-size:12px;font-weight:700;color:#f87171;border-bottom:1px solid #e5e7eb;text-align:center">${item.usage?'-'+item.usage:'‚Äî'}</td>` : '';
      const lossCell = sn==='TRIMARK' ? `<td style="padding:8px 10px;font-size:12px;color:#f87171;border-bottom:1px solid #e5e7eb;text-align:center">${item.brkgCost?'$'+item.brkgCost:'‚Äî'}</td>` : '';
      const triColspan = sn==='TRIMARK' ? 8 : 5;
      return `<tr style="background:${bg}">
        <td style="padding:8px 10px;font-size:13px;border-bottom:1px solid #e5e7eb">${item.name}</td>
        <td style="padding:8px 10px;font-size:12px;color:#6b7280;border-bottom:1px solid #e5e7eb;text-align:center">${item.pack}</td>
        ${begCell}${usedCell}${lossCell}
        <td style="padding:8px 10px;font-size:12px;color:#6b7280;border-bottom:1px solid #e5e7eb;text-align:center">${item.onHand||'‚Äî'}</td>
        <td style="padding:8px 10px;font-size:13px;font-weight:700;border-bottom:1px solid #e5e7eb;text-align:center">${item.orderQty}</td>
        <td style="padding:8px 10px;font-size:11px;font-weight:700;color:${sc};border-bottom:1px solid #e5e7eb;text-align:center">${sl}</td>
      </tr>${item.note?`<tr style="background:${bg}"><td colspan="${triColspan}" style="padding:2px 10px 8px;font-size:11px;color:#92400e;font-style:italic;border-bottom:1px solid #e5e7eb">‚Ü≥ ${item.note}</td></tr>`:''}`
    }).join('');
    const hasBrkCol = sn === 'TRIMARK';
    return `<div style="margin-bottom:24px;break-inside:avoid">
      <div style="background:${sup?.color||'#333'};color:#fff;padding:10px 14px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between">
        <span style="font-family:monospace;font-size:14px;font-weight:700;letter-spacing:1px">${sn}</span>
        <span style="font-size:11px;opacity:0.7">${ordered.length} item${ordered.length!==1?'s':''} ordered</span>
      </div>
      <table style="width:100%;border-collapse:collapse;border:1px solid #e5e7eb;border-top:none">
        <thead><tr style="background:#f3f4f6">
          <th style="padding:7px 10px;font-size:10px;color:#6b7280;text-align:left;font-family:monospace;border-bottom:2px solid #e5e7eb">ITEM</th>
          <th style="padding:7px 10px;font-size:10px;color:#6b7280;text-align:center;font-family:monospace;border-bottom:2px solid #e5e7eb">PACK</th>
          ${hasBrkCol?'<th style="padding:7px 10px;font-size:10px;color:#a78bfa;text-align:center;font-family:monospace;border-bottom:2px solid #e5e7eb">BEGIN</th><th style="padding:7px 10px;font-size:10px;color:#f87171;text-align:center;font-family:monospace;border-bottom:2px solid #e5e7eb">USED</th><th style="padding:7px 10px;font-size:10px;color:#f87171;text-align:center;font-family:monospace;border-bottom:2px solid #e5e7eb">LOSS $</th>':''}
          <th style="padding:7px 10px;font-size:10px;color:#6b7280;text-align:center;font-family:monospace;border-bottom:2px solid #e5e7eb">ENDING</th>
          <th style="padding:7px 10px;font-size:10px;color:#6b7280;text-align:center;font-family:monospace;border-bottom:2px solid #e5e7eb">ORDER QTY</th>
          <th style="padding:7px 10px;font-size:10px;color:#6b7280;text-align:center;font-family:monospace;border-bottom:2px solid #e5e7eb">STATUS</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
  }).join('');

  const alertSec = (critItems.length||lowItems.length) ? `<div style="margin-bottom:24px;padding:14px 16px;background:#fff7ed;border:2px solid #fed7aa;border-radius:10px;break-inside:avoid">
    <div style="font-family:monospace;font-size:11px;font-weight:700;color:#92400e;letter-spacing:1px;margin-bottom:10px">‚ö† ATTENTION REQUIRED</div>
    ${critItems.length?`<div style="margin-bottom:8px"><div style="font-size:11px;font-weight:700;color:#dc2626;margin-bottom:4px">üî¥ CRITICAL (${critItems.length})</div>${critItems.map(i=>`<div style="font-size:12px;color:#7f1d1d;padding:2px 0 2px 12px">‚Ä¢ ${i.name} ‚Äî on hand: ${i.onHand||'0'}</div>`).join('')}</div>`:''}
    ${lowItems.length?`<div><div style="font-size:11px;font-weight:700;color:#d97706;margin-bottom:4px">üü° LOW STOCK (${lowItems.length})</div>${lowItems.map(i=>`<div style="font-size:12px;color:#78350f;padding:2px 0 2px 12px">‚Ä¢ ${i.name} ‚Äî on hand: ${i.onHand||'0'} / par ${i.par}</div>`).join('')}</div>`:''}
  </div>` : '';

  const noteSec = rec.globalNote ? `<div style="margin-bottom:24px;padding:14px 16px;background:#fefce8;border:2px solid #fde68a;border-radius:10px;break-inside:avoid">
    <div style="font-family:monospace;font-size:11px;font-weight:700;color:#92400e;letter-spacing:1px;margin-bottom:8px">üìù ORDER NOTES</div>
    <div style="font-size:13px;color:#1c1917;line-height:1.6">${rec.globalNote}</div>
  </div>` : '';

  const html = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Bartlett's Order ‚Äî ${dateStr}</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#fff;color:#111;padding:24px;max-width:780px;margin:0 auto}
    @media print{body{padding:0}.no-print{display:none!important}@page{margin:1.5cm;size:A4}}
  </style></head><body>
  <div class="no-print" style="text-align:right;margin-bottom:20px">
    <button onclick="window.print()" style="padding:10px 24px;background:#16a34a;color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer">üñ® Print / Save PDF</button>
    <button onclick="window.close()" style="padding:10px 20px;background:#f3f4f6;color:#374151;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;margin-left:8px">‚úï Close</button>
  </div>
  <div style="border-bottom:3px solid #16a34a;padding-bottom:16px;margin-bottom:24px">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px">
      <div><div style="font-size:22px;font-weight:700;color:#ef4444;letter-spacing:2px;font-family:monospace">BARTLETT'S</div>
      <div style="font-size:11px;color:#6b7280;letter-spacing:2px;margin-top:2px;font-family:monospace">ORDER SUMMARY</div></div>
      <div style="text-align:right"><div style="font-size:16px;font-weight:700">${dateStr}</div><div style="font-size:12px;color:#6b7280;margin-top:2px">Placed at ${timeStr}</div></div>
    </div>
    ${deliveryStr ? `
    <div style="margin-top:14px;display:inline-flex;align-items:center;gap:10px;background:#f0fdf4;border:2px solid #16a34a;border-radius:10px;padding:10px 18px;">
      <span style="font-size:22px;">üöö</span>
      <div>
        <div style="font-family:monospace;font-size:11px;font-weight:700;color:#15803d;letter-spacing:1px;">EXPECTED DELIVERY</div>
        <div style="font-size:18px;font-weight:800;color:#111;margin-top:2px;">${deliveryStr}</div>
      </div>
    </div>` : ''}
    <div style="display:flex;gap:16px;margin-top:16px;flex-wrap:wrap">
      <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:8px 14px;text-align:center"><div style="font-size:18px;font-weight:700;color:#16a34a;font-family:monospace">${orderedItems.length}</div><div style="font-size:10px;color:#6b7280;font-family:monospace">ITEMS ORDERED</div></div>
      <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:8px 14px;text-align:center"><div style="font-size:18px;font-weight:700;color:#16a34a;font-family:monospace">${Object.keys(rec.suppliers||{}).length}</div><div style="font-size:10px;color:#6b7280;font-family:monospace">SUPPLIERS</div></div>
      ${critItems.length?`<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:8px 14px;text-align:center"><div style="font-size:18px;font-weight:700;color:#dc2626;font-family:monospace">${critItems.length}</div><div style="font-size:10px;color:#6b7280;font-family:monospace">CRITICAL</div></div>`:''}
      ${lowItems.length?`<div style="background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:8px 14px;text-align:center"><div style="font-size:18px;font-weight:700;color:#d97706;font-family:monospace">${lowItems.length}</div><div style="font-size:10px;color:#6b7280;font-family:monospace">LOW STOCK</div></div>`:''}
    </div>
  </div>
  ${alertSec}${noteSec}${supBlocks}
  <div style="margin-top:32px;padding-top:14px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px">
    <div style="font-size:10px;color:#9ca3af;font-family:monospace">¬© 2025 Oscar Rivas ¬∑ Bartlett's Restaurant ¬∑ All rights reserved</div>
    <div style="font-size:10px;color:#9ca3af;font-family:monospace">Printed: ${new Date().toLocaleString('en-US')}</div>
  </div></body></html>`;

  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const w = window.open(url, '_blank');
  if (!w) {
    const a = document.createElement('a');
    a.href=url; a.target='_blank'; a.rel='noopener';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }
  setTimeout(() => URL.revokeObjectURL(url), 60000);
}

// ‚îÄ‚îÄ‚îÄ WHAT'S NEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showWhatsNew() {
  const existing = document.getElementById('whats-new-sheet');
  if (existing) { existing.remove(); return; }

  const overlay = document.createElement('div');
  overlay.id = 'whats-new-sheet';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:9500;display:flex;align-items:flex-end;';
  overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };

  const updates = [
    { icon:'üí°', title:'ELECTRICAL Tab', desc:'Brand new tab for lightbulb orders. All 12 bulb types are listed with their location in the restaurant. Tap ‚úé EDIT VENDOR to add your supplier\'s email ‚Äî after that, orders go straight to them automatically.' },
    { icon:'üëÜ', title:'Swipe to Clear', desc:'On any item row, swipe your finger to the LEFT. A red üóë CLEAR button appears. Tap it to instantly zero out that item\'s on-hand count and order quantity. Swipe back right to cancel.' },
    { icon:'üì¶', title:'Delivery Confirmation', desc:'Open any ABCO, BEK, or Trimark order in History. Tap the blue üì¶ CONFIRM DELIVERY button. Check off each item as it arrives on the dock. If something didn\'t show up, leave it unchecked. The app will flag it as MISSING and remind you until the vendor fixes it.' },
    { icon:'üß†', title:'The App is Learning', desc:'Every time you place an order, the app quietly remembers: what you ordered, how much, and what day it was. After a few months it will start suggesting your usual orders automatically ‚Äî saving you from having to think about routine items.' },
  ];

  overlay.innerHTML = `
    <div style="background:#111;border-radius:24px 24px 0 0;width:100%;max-height:85vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:20px 20px calc(24px + env(safe-area-inset-bottom));">
      <div style="width:36px;height:4px;background:#3a3a3c;border-radius:2px;margin:0 auto 16px;"></div>

      <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;">
        <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:16px;font-weight:700;color:#f2f2f7;">What's New</div>
        <div style="background:#ef4444;color:#fff;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:9px;font-weight:700;padding:2px 8px;border-radius:10px;letter-spacing:0.5px;">v1.5</div>
      </div>
      <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#48484a;margin-bottom:20px;letter-spacing:0.5px;">February 2026 ¬∑ Bartlett's Order Management</div>

      ${updates.map(u => `
        <div style="background:#1c1c1e;border-radius:14px;padding:14px 16px;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
            <span style="font-size:22px;">${u.icon}</span>
            <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:12px;font-weight:700;color:#f2f2f7;letter-spacing:0.5px;">${u.title}</div>
          </div>
          <div style="font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif;font-size:14px;color:#a3a3a3;line-height:1.65;">${u.desc}</div>
        </div>`).join('')}

      <div style="background:#0f172a;border:1.5px solid #1e3a5f;border-radius:14px;padding:14px 16px;margin-bottom:16px;">
        <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;font-weight:700;color:#60a5fa;letter-spacing:1px;margin-bottom:6px;">üí° TIP</div>
        <div style="font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif;font-size:13px;color:#93c5fd;line-height:1.6;">
          Tap the version number in the top bar anytime to come back to this screen and review what's new.
        </div>
      </div>

      <button onclick="document.getElementById('whats-new-sheet').remove()" style="
        width:100%;height:50px;border-radius:14px;border:none;
        background:#ef4444;color:#fff;
        font-family:ui-monospace,'SF Mono','Courier New',monospace;
        font-size:14px;font-weight:700;cursor:pointer;letter-spacing:0.5px;">
        GOT IT ‚úì
      </button>
    </div>`;

  document.body.appendChild(overlay);
}

// ‚îÄ‚îÄ‚îÄ MUST KNOW DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MUST_KNOW = [
  {
    supplier: 'üí° HOW TO USE THIS APP',
    color: '#1c1917', accent: '#a8a29e',
    isGeneral: true,
    notes: [
      '1Ô∏è‚É£ Enter ON HAND counts for every item you check',
      '2Ô∏è‚É£ ORDER qty auto-fills (par minus on hand) ‚Äî adjust if needed',
      '3Ô∏è‚É£ Add item notes with ‚úé for anything staff should know',
      '4Ô∏è‚É£ Tap ‚úé EDIT in top bar to update item names, pack sizes, or pars',
      '5Ô∏è‚É£ Hit üíæ SAVE when done ‚Äî this locks the order to history',
      '6Ô∏è‚É£ Print from History tab to post for the team',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üëÜ HOW TO SWIPE TO CLEAR AN ITEM',
      'Sometimes you just want to erase what you typed and start fresh on one item. Here is how:',
      'üü† STEP 1 ‚Äî Find the item row you want to clear',
      'üü† STEP 2 ‚Äî Put your finger on the row and slowly slide it to the LEFT (like sliding a door)',
      'üü† STEP 3 ‚Äî A red üóë CLEAR button will appear on the right side of the row',
      'üü† STEP 4 ‚Äî Tap CLEAR and both the on-hand count and order quantity are erased instantly',
      'üü† STEP 5 ‚Äî If you changed your mind, slide your finger back to the RIGHT to close it without clearing',
      '‚úÖ That is it! The row is blank again and ready for a fresh count.',
    ]
  },
  {
    supplier: 'üî¥ CRITICAL RULES',
    color: '#450a0a', accent: '#f87171',
    isGeneral: true,
    notes: [
      'üî¥ CRITICAL = on hand is 0 or below ‚Äî order immediately, same day',
      'üü° LOW = on hand is below par ‚Äî order on next scheduled delivery',
      '‚úÖ Par levels are the MINIMUM we need to have at all times',
      'üìä When in doubt, order more ‚Äî running out costs more than overstock',
      'üóìÔ∏è Check order history before placing ‚Äî avoid duplicate orders',
      'üñ®Ô∏è Print the order summary and post it so all staff know what\'s coming',
    ]
  },
  {
    supplier: 'ABCO',
    color: '#1e4d35', accent: '#4ade80',
    contact: 'Hal Nouvealty',
    phone: '512-801-5422',
    method: 'SMS',
    cutoffs: [
      { day: 'Same day',  time: 'before 10:30 AM', delivery: 'Same day ‚ö°' },
      { day: 'Sunday',    time: 'before 3:00 PM', delivery: 'Monday' },
      { day: 'Wednesday', time: 'before 3:00 PM', delivery: 'Thursday' },
      { day: 'Thursday',  time: 'before 3:00 PM', delivery: 'Friday (optional)' },
    ],
    notes: [
      '‚ö° Same-day delivery available ‚Äî text Hal before 10:30 AM',
      'üì¶ Minimum order may apply ‚Äî confirm with Hal if ordering small quantities',
      'üì± TEXT orders only ‚Äî do not call',
      'üîÑ Check Bio Pak stock carefully ‚Äî both sizes run out fast on weekends',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üì¶ HOW TO CONFIRM AN ABCO DELIVERY',
      'When the ABCO delivery arrives, do this right away so nothing gets missed:',
      'üîµ STEP 1 ‚Äî Go to the History tab at the bottom of the screen',
      'üîµ STEP 2 ‚Äî Find today\'s ABCO order and tap on it to open it',
      'üîµ STEP 3 ‚Äî Tap the blue üì¶ CONFIRM DELIVERY button at the top',
      'üîµ STEP 4 ‚Äî A checklist appears showing every item that was ordered. Every item starts out with a green checkmark ‚úì meaning it arrived.',
      'üîµ STEP 5 ‚Äî If something did NOT arrive, tap the green checkmark to uncheck it. It will turn red.',
      'üîµ STEP 6 ‚Äî When done checking, tap the green CONFIRM DELIVERY button at the bottom',
      '‚úÖ The app will save everything. If any items were missing, a red reminder banner will appear at the top of the screen until the vendor fixes the shortage.',
      '‚ö†Ô∏è Always confirm deliveries the same day they arrive ‚Äî do not wait.',
    ]
  },
  {
    supplier: 'BEK',
    color: '#0f172a', accent: '#60a5fa',
    contact: 'Online Portal',
    phone: 'BekEntree.com',
    method: 'Web',
    cutoffs: [
      { day: 'Sunday',    time: 'before 4:00 PM', delivery: 'Monday' },
      { day: 'Wednesday', time: 'before 4:00 PM', delivery: 'Thursday' },
      { day: 'Friday',    time: 'before 4:00 PM', delivery: 'Saturday' },
    ],
    notes: [
      'üíª Login: Bartletts@bartlettsaustin.com ¬∑ Burnet2808!',
      'üß§ Gloves are high-velocity ‚Äî check both Poly and Nitrile weekly',
      'üßª Paper goods (towels, TP, Z-fold) ‚Äî order before you think you need to',
      'üè∑Ô∏è Day dots: keep all 7 days stocked. Running out = labeling stops.',
      'üõ¢Ô∏è FRYER OIL ‚Äî order from BEK. Par is 10 cases.',
      'üóìÔ∏è Oil dump days are Wednesday & Thursday ‚Äî always have stock before then',
      '‚ö†Ô∏è Never let oil drop below 3 cases ‚Äî running out mid-service is not an option',
      'üìÖ Order oil on Sunday or Monday delivery to be stocked before Wed dump',
      '‚ö†Ô∏è Confirm delivery windows around holidays ‚Äî schedule changes',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üì¶ HOW TO CONFIRM A BEK DELIVERY',
      'When the BEK order arrives, confirm it the same day:',
      'üîµ STEP 1 ‚Äî Go to History tab and find today\'s BEK order',
      'üîµ STEP 2 ‚Äî Tap it to open, then tap üì¶ CONFIRM DELIVERY',
      'üîµ STEP 3 ‚Äî All items start checked ‚úì (received). Uncheck anything missing.',
      'üîµ STEP 4 ‚Äî Tap CONFIRM DELIVERY when done',
      '‚úÖ Missing items get flagged with a red banner reminder until resolved.',
    ]
  },
  {
    supplier: 'AMAZON',
    color: '#7c2d12', accent: '#fb923c',
    contact: 'Amazon Business',
    phone: 'bartletts@bartlettsaustin.com',
    method: 'Web',
    cutoffs: [
      { day: 'Any day', time: 'As needed', delivery: '1‚Äì2 business days (Prime)' },
    ],
    notes: [
      'üîë Login: bartletts@bartlettsaustin.com ¬∑ 2408Anderson!',
      'ü™ë High chairs: keep 6 on floor minimum ‚Äî order before dropping below 5',
      'ü©π Blue bandaids & finger cots are health code items ‚Äî never run out',
      'ü™• Dental floss picks refill at host stand monthly',
      'ü´ô Check soap dispensers quarterly for breakage',
      'üì¶ Bundle small orders to avoid multiple deliveries ‚Äî check weekly',
    ]
  },
  {
    supplier: 'TRIMARK',
    color: '#3b0764', accent: '#c084fc',
    contact: 'James Hawley',
    phone: 'James.Hawley@trimarkusa.com',
    method: 'Email',
    cutoffs: [
      { day: 'Monthly', time: 'After inventory count', delivery: 'Varies ‚Äî confirm with James' },
    ],
    notes: [
      'üìß Always email James directly ‚Äî do not order through portal alone',
      'üç∑ Wine & champagne glasses break fastest ‚Äî count weekly during service',
      'üçΩÔ∏è Ala plates & salad plates are high volume ‚Äî maintain full par',
      'ü•Ñ Silverware (fork/knife/spoon) counts should happen every inventory',
      '‚è±Ô∏è Lead time can be 1‚Äì2 weeks ‚Äî never wait until you\'re out',
      'üìã After inventory: pull counts, compare to par, send one combined order',
      'üíú Tip plates: 250 par ‚Äî guests take them, losses are normal',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üì¶ HOW TO CONFIRM A TRIMARK DELIVERY',
      'When James\'s order arrives (usually 1‚Äì2 weeks after emailing):',
      'üîµ STEP 1 ‚Äî Go to History tab and find the Trimark order you placed',
      'üîµ STEP 2 ‚Äî Tap it to open, then tap üì¶ CONFIRM DELIVERY',
      'üîµ STEP 3 ‚Äî All ordered items start checked ‚úì. Uncheck anything that did not arrive.',
      'üîµ STEP 4 ‚Äî Tap CONFIRM DELIVERY when done',
      '‚úÖ If anything is missing the app flags it. Tap MARK AS RESOLVED once James ships the rest.',
    ]
  },
  {
    supplier: 'üì¶ TRIMARK ‚Äî HOW TO DO INVENTORY',
    color: '#2e1065', accent: '#c084fc',
    isGeneral: true,
    notes: [
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ STEP 1 ‚Äî OPEN INVENTORY MODE',
      'Go to the TRIMARK tab at the top of the screen. Tap the purple üìã INVENTORY COUNT button. The screen will switch to show all items with BEGIN and COUNT columns.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ STEP 2 ‚Äî CHECK YOUR BEGIN NUMBERS',
      'The BEGIN column shows last month\'s ending count. These should already be filled in purple. ‚úÖ If they\'re there ‚Äî great, move on. ‚ö†Ô∏è If they\'re empty ‚Äî last month\'s data was cleared, enter the counts manually from the previous paper sheet.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ STEP 3 ‚Äî COUNT EVERY ITEM',
      'Walk through the restaurant with this screen open. For each item, tap the COUNT cell. A window will pop up showing 3 locations:',
      'üö¢ DOCK ‚Äî anything in the receiving area',
      'üö™ CLOSET ‚Äî anything in dry storage or shelves',
      'üçΩÔ∏è RESTAURANT ‚Äî everything on the floor, in coolers, behind the bar',
      'Type your counts separated by spaces. Example: you find rocks glasses in 3 spots ‚Äî type  8  5  12  and the app adds them up to 25 for you automatically.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ STEP 4 ‚Äî READ THE NUMBERS',
      'After entering each COUNT the row will show:',
      'üî¥ USED ‚Äî how many were used or broken this month (Begin minus Count)',
      'üí∏ LOSS $ ‚Äî dollar value of what was lost (shown under the item name)',
      'üü° ORDER ‚Äî how many we need to order to get back to par',
      '‚úÖ CHECK MARK ‚Äî means we\'re at or above par, no order needed',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ STEP 5 ‚Äî PLACE THE ORDER',
      'Tap the üìã INVENTORY COUNT button again to go back to the ORDER view. You will see all items that need ordering already filled in yellow. Review the quantities. When everything looks right, tap üíæ SAVE.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ STEP 6 ‚Äî SEND EMAIL TO JAMES',
      'After saving, a purple üìß Email James? prompt will pop up at the bottom of the screen. Tap OPEN EMAIL. Your mail app will open with the full order already written out ‚Äî James\'s email, subject line, and all items listed. Just tap SEND. Done! ‚úÖ',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      '‚ö†Ô∏è IMPORTANT REMINDERS',
      '‚Ä¢ Count EVERY item ‚Äî even if you think it\'s fine. Surprises are expensive.',
      '‚Ä¢ If something seems way off (like 0 rocks glasses) double-check before saving.',
      '‚Ä¢ The app resets automatically after saving ‚Äî next month\'s BEGIN will be tonight\'s COUNT.',
      '‚Ä¢ If you need to fix a mistake after saving, go to History, find the order, and note the correction.',
    ]
  },
  {
    supplier: 'üí° ELECTRICAL TAB ‚Äî HOW IT WORKS',
    color: '#1a1a2e', accent: '#f59e0b',
    isGeneral: true,
    notes: [
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü° WHAT IS THE ELECTRICAL TAB?',
      'The ELECTRICAL tab is where you manage lightbulb orders for the restaurant. Every bulb type used at Bartlett\'s is listed there with the location where it belongs ‚Äî so you always know exactly which bulb goes where.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü° STEP 1 ‚Äî SET UP YOUR VENDOR (do this first, only once)',
      'Before you can send orders you need to add your supplier\'s information. Here is how:',
      '‚Ä¢ Go to the ELECTRICAL tab',
      '‚Ä¢ At the top of the screen you will see a yellow ‚úé EDIT VENDOR button',
      '‚Ä¢ Tap it ‚Äî a window will open asking for 3 things:',
      '  1. Vendor / Company Name (the name of the store or supplier)',
      '  2. Contact Name (the person you deal with)',
      '  3. Email Address (where the order gets sent)',
      '‚Ä¢ Fill in all three and tap SAVE VENDOR INFO',
      '‚úÖ You only have to do this once. From now on, every electrical order will go to that email automatically.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü° STEP 2 ‚Äî COUNT YOUR BULBS',
      'Walk through the restaurant. For each bulb type, check how many spares you have in storage. Type that number in the ON HAND column next to the bulb.',
      'The ORDER column will auto-fill to show how many you need to get back to par.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü° STEP 3 ‚Äî PLACE THE ORDER',
      'When you are done counting, tap üíæ SAVE. After saving, a yellow üí° Email Electrical Vendor? prompt will pop up at the bottom of the screen.',
      '‚Ä¢ Tap OPEN EMAIL',
      '‚Ä¢ Your email app opens with the full order already written ‚Äî vendor email, subject line, and all items listed with quantities and locations',
      '‚Ä¢ Tap SEND ‚úÖ',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      '‚ö†Ô∏è IMPORTANT NOTES',
      '‚Ä¢ The location shown under each bulb name tells you exactly where in the restaurant it is used ‚Äî use this when replacing bulbs',
      '‚Ä¢ Par levels are the minimum number of spare bulbs to keep in storage at all times',
      '‚Ä¢ Unit costs are not set yet ‚Äî they will be added in a future update',
    ]
  },
  {
    supplier: 'üß† THE APP IS LEARNING ‚Äî WHAT THAT MEANS',
    color: '#0c0a1e', accent: '#818cf8',
    isGeneral: true,
    notes: [
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ WHAT IS THE APP LEARNING?',
      'Every single time you place an order, the app quietly writes down three things:',
      '‚Ä¢ WHAT you ordered (which items)',
      '‚Ä¢ HOW MUCH you ordered (the quantities)',
      '‚Ä¢ WHEN you ordered it (the day of the week and the month)',
      'It does this silently in the background. You will not see it happen. Nothing changes on screen.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ WHY IS IT DOING THIS?',
      'Think of it like a new employee who watches everything you do and takes notes. After a few months they start to know your routine ‚Äî "every Sunday we order 2 cases of Bio Pak" or "every month we need more rocks glasses."',
      'The app is doing the same thing. It is building a picture of how Bartlett\'s operates.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ WHAT HAPPENS NEXT?',
      'After about 3 months of good data, the app will move to Stage 2. That means it will start showing you suggestions ‚Äî "Based on your last 4 Sundays, you usually order 2 cases of Bio Pak. Want to add it?" You can say yes or no.',
      'Eventually, the goal is for the app to pre-fill your whole routine order automatically. You just review it, adjust anything unusual, and hit save. No more starting from scratch every time.',
      '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
      'üü£ DO I NEED TO DO ANYTHING?',
      'No. Just keep using the app normally. The more orders you place through the app, the smarter it gets. The data is saved privately on your device and in your Firebase account ‚Äî nobody else can see it.',
      '‚úÖ Stage 2 is expected around May or June 2026.',
    ]
  },
  document.getElementById('view-order').style.display = 'none';
  document.getElementById('view-history').style.display = 'none';
  document.getElementById('view-mustknow').style.display = 'flex';

  const scroll = document.getElementById('mustknow-scroll');
  scroll.innerHTML = '';

  // Header
  const hdr = document.createElement('div');
  hdr.style.cssText = 'padding:16px 16px 8px;';
  hdr.innerHTML = `<div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;color:#636366;letter-spacing:1.5px;margin-bottom:2px">QUICK REFERENCE</div>
    <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:18px;font-weight:700;color:#f2f2f7">Must Know</div>`;
  scroll.appendChild(hdr);

  MUST_KNOW.forEach(section => {
    const card = document.createElement('div');
    card.style.cssText = 'margin:8px 16px;border-radius:16px;overflow:hidden;';

    // Card header
    const cardHdr = document.createElement('div');
    cardHdr.style.cssText = `background:${section.color};padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;`;

    if (!section.isGeneral) {
      cardHdr.innerHTML = `
        <div>
          <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:14px;font-weight:700;color:#fff;letter-spacing:1px">${section.supplier}</div>
          <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px">${section.method} ¬∑ ${section.phone}</div>
        </div>
        <div style="text-align:right">
          <div style="color:${section.accent};font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;font-weight:700;letter-spacing:0.5px">CONTACT</div>
          <div style="color:#fff;font-family:-apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;font-size:12px;margin-top:1px">${section.contact}</div>
        </div>`;
    } else {
      cardHdr.innerHTML = `<div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;color:#fff">${section.supplier}</div>`;
    }
    card.appendChild(cardHdr);

    // Cutoffs
    if (section.cutoffs) {
      const cutoffBlock = document.createElement('div');
      cutoffBlock.style.cssText = `background:${section.color};opacity:0.85;padding:0 16px 10px;`;
      cutoffBlock.style.background = section.color;
      cutoffBlock.style.filter = 'brightness(1.15)';

      section.cutoffs.forEach(c => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-top:1px solid rgba(255,255,255,0.08);';
        row.innerHTML = `
          <div>
            <span style="color:${section.accent};font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700">${c.day}</span>
            <span style="color:rgba(255,255,255,0.5);font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;margin-left:8px">${c.time}</span>
          </div>
          <div style="color:rgba(255,255,255,0.6);font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px">‚Üí ${c.delivery}</div>`;
        cutoffBlock.appendChild(row);
      });

      // Add the cutoffBlock with matching color bg
      const cutoffWrap = document.createElement('div');
      cutoffWrap.style.cssText = `background:${section.color};padding:0 16px 10px;filter:brightness(1.12);`;
      section.cutoffs.forEach(c => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-top:1px solid rgba(255,255,255,0.08);';
        row.innerHTML = `
          <div>
            <span style="color:${section.accent};font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:11px;font-weight:700">${c.day}</span>
            <span style="color:rgba(255,255,255,0.5);font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;margin-left:8px">${c.time}</span>
          </div>
          <div style="color:rgba(255,255,255,0.65);font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px">‚Üí ${c.delivery}</div>`;
        cutoffWrap.appendChild(row);
      });
      card.appendChild(cutoffWrap);
    }

    // Notes list
    const notesList = document.createElement('div');
    notesList.style.cssText = 'background:#111;';
    section.notes.forEach((note, idx) => {
      const noteEl = document.createElement('div');
      noteEl.style.cssText = `padding:11px 16px;border-top:1px solid #1c1c1e;font-family:-apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;font-size:14px;color:#e5e5e7;line-height:1.45;${idx === section.notes.length - 1 ? '' : ''}`;
      noteEl.textContent = note;
      notesList.appendChild(noteEl);
    });
    card.appendChild(notesList);

    scroll.appendChild(card);
  });

  const spacer = document.createElement('div'); spacer.className = 'safe-bottom';
  scroll.appendChild(spacer);
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  state.tab = tab;
  state.editMode = false;
  state.editingItem = null;
  state.selectedRec = null;
  state.trimarkView = 'order';
  // Hide all views
  document.getElementById('view-order').style.display = 'none';
  document.getElementById('view-history').style.display = 'none';
  document.getElementById('view-mustknow').style.display = 'none';
  document.getElementById('hist-detail').classList.remove('show');
  render();
}

// ‚îÄ‚îÄ‚îÄ INSTALL BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dismissInstall() {
  document.getElementById('install-banner').classList.remove('show');
  lsSet('bartletts-install-dismissed', true);
}

function checkInstallPrompt() {
  // Show only if: not dismissed, not standalone, on iOS Safari
  const dismissed = lsGet('bartletts-install-dismissed');
  if (dismissed) return;
  const isStandalone = window.navigator.standalone === true ||
    window.matchMedia('(display-mode: standalone)').matches;
  if (isStandalone) return;
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isSafari = /safari/i.test(navigator.userAgent) && !/chrome/i.test(navigator.userAgent) && !/crios/i.test(navigator.userAgent);
  const isMac = /macintosh/i.test(navigator.userAgent);
  if (isIOS || isSafari || isMac) {
    setTimeout(() => document.getElementById('install-banner').classList.add('show'), 1500);
  }
}

// ‚îÄ‚îÄ‚îÄ LOCATION TALLY MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _tallyItemId = null;
let _tallyOnEndInput = null;

// Parse a field like "8  2  3  2" ‚Üí sum of all valid numbers
function parseTallyField(val) {
  return (val.match(/[\d.]+/g) || [])
    .map(n => parseFloat(n) || 0)
    .reduce((a, b) => a + b, 0);
}

function openElectricalVendorEdit() {
  const sup = state.catalog['ELECTRICAL'] || DEFAULT_SUPPLIERS['ELECTRICAL'];
  const existing = document.getElementById('elc-vendor-sheet');
  if (existing) { existing.remove(); return; }

  const overlay = document.createElement('div');
  overlay.id = 'elc-vendor-sheet';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9000;display:flex;align-items:flex-end;';
  overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };

  overlay.innerHTML = `
    <div style="background:#111;border-radius:24px 24px 0 0;width:100%;padding:20px 20px calc(20px + env(safe-area-inset-bottom));">
      <div style="width:36px;height:4px;background:#3a3a3c;border-radius:2px;margin:0 auto 16px;"></div>
      <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;color:#f59e0b;letter-spacing:1px;margin-bottom:16px;">üí° ELECTRICAL VENDOR INFO</div>
      <div style="margin-bottom:14px;">
        <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#636366;letter-spacing:1px;margin-bottom:6px;">VENDOR / COMPANY NAME</div>
        <input id="elc-vendor-name" type="text" value="${sup.vendorName||''}" placeholder="e.g. ABC Lighting Supply"
          style="width:100%;box-sizing:border-box;height:46px;padding:0 14px;border-radius:10px;border:2px solid #3a3a3c;background:#1c1c1e;color:#f2f2f7;font-size:16px;outline:none;">
      </div>
      <div style="margin-bottom:14px;">
        <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#636366;letter-spacing:1px;margin-bottom:6px;">CONTACT NAME</div>
        <input id="elc-contact-name" type="text" value="${sup.contact||''}" placeholder="e.g. John Smith"
          style="width:100%;box-sizing:border-box;height:46px;padding:0 14px;border-radius:10px;border:2px solid #3a3a3c;background:#1c1c1e;color:#f2f2f7;font-size:16px;outline:none;">
      </div>
      <div style="margin-bottom:20px;">
        <div style="font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:10px;color:#636366;letter-spacing:1px;margin-bottom:6px;">EMAIL ADDRESS</div>
        <input id="elc-email" type="email" inputmode="email" value="${sup.email||''}" placeholder="vendor@example.com"
          style="width:100%;box-sizing:border-box;height:46px;padding:0 14px;border-radius:10px;border:2px solid #3a3a3c;background:#1c1c1e;color:#f2f2f7;font-size:16px;outline:none;">
      </div>
      <div style="display:flex;gap:10px;">
        <button onclick="document.getElementById('elc-vendor-sheet').remove()" style="flex:1;height:48px;border-radius:14px;background:transparent;border:1.5px solid #3a3a3c;color:#636366;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;cursor:pointer;">Cancel</button>
        <button onclick="saveElectricalVendor()" style="flex:2;height:48px;border-radius:14px;background:#f59e0b;border:none;color:#000;font-family:ui-monospace,'SF Mono','Courier New',monospace;font-size:13px;font-weight:700;cursor:pointer;letter-spacing:0.5px;">‚úì SAVE VENDOR INFO</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function saveElectricalVendor() {
  const vendorName = document.getElementById('elc-vendor-name').value.trim();
  const contact    = document.getElementById('elc-contact-name').value.trim();
  const email      = document.getElementById('elc-email').value.trim();

  if (!state.catalog['ELECTRICAL']) state.catalog['ELECTRICAL'] = JSON.parse(JSON.stringify(DEFAULT_SUPPLIERS['ELECTRICAL']));
  state.catalog['ELECTRICAL'].vendorName = vendorName;
  state.catalog['ELECTRICAL'].contact = contact;
  state.catalog['ELECTRICAL'].email = email;

  lsSet('bartletts-catalog-v1', state.catalog);
  document.getElementById('elc-vendor-sheet').remove();
  renderItems();
  showToast('‚úÖ Vendor info saved');
}


  _tallyItemId = item.id;
  _tallyOnEndInput = onConfirm;

  const tally = state.trimarkTally[item.id] || {};
  document.getElementById('tally-item-name').textContent = item.name;
  document.getElementById('tally-item-sub').textContent = 'par ' + item.par + (item.unitCost ? ' ¬∑ $' + item.unitCost.toFixed(2) + ' ea' : '');

  // Restore previous raw string values if saved, otherwise blank
  document.getElementById('tally-dock').value       = tally.dockRaw       || '';
  document.getElementById('tally-closet').value     = tally.closetRaw     || '';
  document.getElementById('tally-restaurant').value = tally.restaurantRaw || '';

  updateTallyTotal();
  document.getElementById('tally-modal').style.display = 'flex';
  setTimeout(() => {
    const d = document.getElementById('tally-dock');
    if (!d.value) d.focus(); 
    else document.getElementById('tally-restaurant').focus();
  }, 100);
}

function updateTallyTotal() {
  const d = parseTallyField(document.getElementById('tally-dock').value);
  const c = parseTallyField(document.getElementById('tally-closet').value);
  const r = parseTallyField(document.getElementById('tally-restaurant').value);

  document.getElementById('tally-dock-sub').textContent       = d || '0';
  document.getElementById('tally-closet-sub').textContent     = c || '0';
  document.getElementById('tally-restaurant-sub').textContent = r || '0';

  const total = d + c + r;
  const el = document.getElementById('tally-total');
  el.textContent = total;
  el.style.color = total > 0 ? '#a78bfa' : '#48484a';
}

function closeTallyModal() {
  document.getElementById('tally-modal').style.display = 'none';
  _tallyItemId = null;
  _tallyOnEndInput = null;
}

function confirmTally() {
  const dockRaw       = document.getElementById('tally-dock').value.trim();
  const closetRaw     = document.getElementById('tally-closet').value.trim();
  const restaurantRaw = document.getElementById('tally-restaurant').value.trim();

  const d = parseTallyField(dockRaw);
  const c = parseTallyField(closetRaw);
  const r = parseTallyField(restaurantRaw);
  const total = d + c + r;

  // Save raw strings so they restore next time, plus computed totals
  if (_tallyItemId) {
    state.trimarkTally[_tallyItemId] = {
      dock: d, closet: c, restaurant: r,
      dockRaw, closetRaw, restaurantRaw
    };
    saveTrimarkTally();
  }

  if (_tallyOnEndInput) _tallyOnEndInput(String(total));
  closeTallyModal();
  showToast(`${d} dock + ${c} closet + ${r} restaurant = ${total}`, 'ok');
}

// Live total update as user types in tally modal
document.addEventListener('DOMContentLoaded', () => {
  ['tally-dock','tally-closet','tally-restaurant'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateTallyTotal);
  });
});

// ‚îÄ‚îÄ‚îÄ PIN LOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PIN_HASH_KEY = 'bartletts-pin-hash-v1';
const PIN_SESSION_KEY = 'bartletts-pin-session';
const DEFAULT_PIN = '2408'; // initial PIN ‚Äî user should change this

function hashPin(pin) {
  // Simple but sufficient hash for a 4-digit PIN
  let h = 0;
  const salt = 'bartletts-oscar-rivas-2025';
  const str = salt + pin + salt;
  for (let i = 0; i < str.length; i++) {
    h = ((h << 5) - h) + str.charCodeAt(i);
    h |= 0;
  }
  return String(h >>> 0);
}

let _pinEntry = '';
let _pinAttempts = 0;
let _pinLockUntil = 0;

function initPinLock() {
  // Check if already unlocked this session
  const session = sessionStorage.getItem(PIN_SESSION_KEY);
  if (session === 'unlocked') {
    document.getElementById('pin-screen').style.display = 'none';
    return;
  }
  // Ensure a PIN hash is stored ‚Äî first run uses default PIN
  if (!localStorage.getItem(PIN_HASH_KEY)) {
    localStorage.setItem(PIN_HASH_KEY, hashPin(DEFAULT_PIN));
  }
  document.getElementById('pin-screen').style.display = 'flex';
}

function pinPress(digit) {
  // Check if locked out
  if (Date.now() < _pinLockUntil) {
    const secs = Math.ceil((_pinLockUntil - Date.now()) / 1000);
    document.getElementById('pin-error').textContent = `Too many attempts. Wait ${secs}s`;
    return;
  }
  if (_pinEntry.length >= 4) return;
  _pinEntry += digit;
  updatePinDots();
  if (_pinEntry.length === 4) {
    setTimeout(checkPin, 120);
  }
}

function pinDel() {
  _pinEntry = _pinEntry.slice(0, -1);
  updatePinDots();
  document.getElementById('pin-error').textContent = '';
}

function updatePinDots() {
  document.querySelectorAll('.pin-dot').forEach((d, i) => {
    d.classList.toggle('filled', i < _pinEntry.length);
  });
}

function checkPin() {
  const stored = localStorage.getItem(PIN_HASH_KEY) || hashPin(DEFAULT_PIN);
  if (hashPin(_pinEntry) === stored) {
    // Correct
    _pinAttempts = 0;
    sessionStorage.setItem(PIN_SESSION_KEY, 'unlocked');
    const screen = document.getElementById('pin-screen');
    screen.style.transition = 'opacity 0.3s';
    screen.style.opacity = '0';
    setTimeout(() => screen.style.display = 'none', 300);
  } else {
    // Wrong
    _pinAttempts++;
    _pinEntry = '';
    updatePinDots();
    document.getElementById('pin-error').textContent = `Incorrect PIN (${_pinAttempts}/5)`;
    // Shake animation
    const dots = document.getElementById('pin-dots');
    dots.style.animation = 'none';
    dots.offsetHeight; // reflow
    dots.style.animation = 'pinShake 0.4s ease';
    // Lock after 5 attempts
    if (_pinAttempts >= 5) {
      _pinLockUntil = Date.now() + 30000;
      _pinAttempts = 0;
      document.getElementById('pin-error').textContent = 'Too many attempts. Wait 30s';
    }
  }
}

// Shake animation
const pinStyle = document.createElement('style');
pinStyle.textContent = `@keyframes pinShake {
  0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)} 40%{transform:translateX(8px)} 60%{transform:translateX(-6px)} 80%{transform:translateX(6px)}
}`;
document.head.appendChild(pinStyle);

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadPersistedData();
render();
checkInstallPrompt();
initPinLock();
updateMissingBanner();
// Delay Firebase init slightly to ensure SDK scripts have loaded
setTimeout(initFirebase, 500);
</script>
</body>
</html>
